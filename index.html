<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- CONFIGURATION IPHONE / PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Journal Chantier">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAnUExURQAAACVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj65/L52UAAAAMdFJOUwAQHz9Azt9vj+D/y0wtOvwAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACwSURBVHhe7cExAQAAAMKg9U9tCy8gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIB3A8VHAAEdjagAAAAASUVORK5CYII=">

    <title>Journal de Chantier</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb;
            --bg-sidebar: #f8fafc;
            --bg-main: #ffffff;
            --border: #e2e8f0;
            --text: #334155;
            --card-active: #eff6ff;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* Base Reset & Font */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
            background: var(--bg-main);
            /* Gestion de l'encoche iPhone */
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* --- LAYOUT DESKTOP --- */
        .sidebar { width: 380px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; height: 100%; z-index: 10; }
        .main-content { flex-grow: 1; background: var(--bg-main); padding: 20px 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; position: relative; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            body { position: relative; display: block; height: 100dvh; /* Dynamic viewport height */ }

            .sidebar {
                width: 100%; height: 100%; position: absolute; top:0; left:0;
                border-right: none; transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
                transform: translateX(0); z-index: 10;
                padding-bottom: 80px; /* Espace pour scrolling */
            }

            .main-content {
                width: 100%; height: 100%; position: absolute; top:0; left:0;
                padding: 15px; padding-bottom: 100px; /* Espace bas */
                transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
                background: white; z-index: 20;
            }

            /* Animation Slide */
            body.view-form .sidebar { transform: translateX(-25%); opacity: 0.5; }
            body.view-form .main-content { transform: translateX(0); }

            .btn-mobile-back { display: block !important; }
            .header-edit { position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 10; padding-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; }

            .entry-card { padding: 16px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
            input, select, textarea { font-size: 16px !important; border-radius: 10px !important; padding: 12px !important; }
            .row { grid-template-columns: 1fr; gap: 12px; }
            .modal-box { width: 100%; height: 100%; max-height: 100%; border-radius: 0; padding-top: 50px; }
        }

        /* --- COMPONENTS --- */
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); background: white; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-weight: 800; color: var(--primary); font-size: 1.2rem; letter-spacing: -0.5px; }
        .btn-settings { background: none; border: none; cursor: pointer; color: #64748b; font-size: 1.4rem; padding: 5px; }

        .search-box { position: relative; margin-bottom: 10px; }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-box input { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--border); border-radius: 10px; background: #f1f5f9; border:none; outline:none; }

        .filter-row select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; background: white; -webkit-appearance: none; }
        .date-range-row { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; background: white; border: 1px solid var(--border); padding: 8px; border-radius: 10px; }
        .date-range-row input { flex: 1; border: none; padding: 5px; font-size: 0.9rem; background: transparent; }

        .action-row { display: flex; gap: 8px; margin-top: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .action-row::-webkit-scrollbar { display: none; }

        .btn-mini { font-size: 0.85rem; padding: 10px 16px; border: 1px solid #e2e8f0; background: white; cursor: pointer; border-radius: 25px; display: flex; align-items: center; gap: 8px; white-space: nowrap; font-weight: 600; color: #334155; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-mini:active { background: #f1f5f9; transform: scale(0.98); }

        .entry-list { flex-grow: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }
        .entry-card.active { border-color: var(--primary); background: #f0f7ff; }

        .card-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #64748b; margin-bottom: 6px; }
        .card-title { font-weight: 700; font-size: 1.05rem; margin-bottom: 6px; color: #0f172a; }
        .card-preview { font-size: 0.9rem; color: #475569; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }

        /* --- FORM --- */
        .form-container { width: 100%; max-width: 800px; padding-bottom: 40px; }
        .header-edit { display: flex; align-items: center; gap: 10px; }
        .btn-mobile-back { display: none; background: none; border: none; font-size: 1.5rem; color: var(--primary); padding: 0 15px 0 5px; cursor: pointer; }
        h2 { margin: 0; color: var(--primary); font-size: 1.3rem; flex-grow: 1; }

        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #475569; }
        input[type="text"], input[type="datetime-local"], select, textarea { width: 100%; border: 1px solid #cbd5e1; background: #fff; appearance: none; }
        textarea { resize: vertical; min-height: 100px; }

        .photo-section { margin-top: 20px; margin-bottom: 25px; border: 2px dashed #cbd5e1; padding: 20px; border-radius: 16px; background: #f8fafc; text-align: center; }
        .photo-gallery { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 15px; justify-content: center; }
        .photo-item { position: relative; width: 100px; height: 100px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-del { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); color: #ef4444; border: none; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .timeline-section { margin-top: 35px; border-top: 4px solid #f1f5f9; padding-top: 20px; }
        .timeline-input-box { background: white; padding: 15px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .timeline-item { position: relative; margin-bottom: 25px; padding-left: 25px; border-left: 2px solid #e2e8f0; margin-left: 5px; }
        .timeline-item::before { content: ''; position: absolute; left: -7px; top: 0; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px #e2e8f0; }

        .btn { padding: 16px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; font-size: 1rem; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; width: 100%; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .btn-success { background: #10b981; color: white; width: 100%; margin-top: 10px; }
        .btn-danger { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .btn-file { background: white; border: 1px solid #cbd5e1; color: #334155; display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; border-radius: 50px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: flex-end; z-index: 1000; backdrop-filter: blur(4px); }
        @media (min-width: 769px) { .modal-overlay { align-items: center; } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- MODAL SETTINGS -->
<div id="settingsModal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title"><i class="fas fa-cog"></i> R√©glages</div>
            <button class="close-modal" onclick="toggleSettings()">&times;</button>
        </div>

        <div class="setting-group">
            <h4>üìÑ PDF & Logo</h4>
            <div class="pdf-setting-container">
                <input type="text" id="pdfTitleInput" placeholder="Titre (ex: Rapport)" onchange="savePdfSettings()" style="margin-bottom:10px;">
                <div style="display:flex; gap:15px; align-items:center;">
                    <div id="logoPreview" style="width:50px; height:50px; background:#f1f5f9; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden;"></div>
                    <label class="btn-mini" style="margin:0;"><i class="fas fa-upload"></i> Logo <input type="file" accept="image/*" style="display:none" onchange="handleLogoUpload(this)"></label>
                    <button class="btn-mini" onclick="removeLogo()" style="color:#ef4444; border-color:#ef4444; margin:0;"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>

        <div class="setting-group">
            <h4>üìç Sites</h4>
            <div class="setting-list" id="siteList"></div>
            <div class="setting-add">
                <input type="text" id="newSiteInput" placeholder="Nouveau site...">
                <button class="btn-mini" onclick="addSetting('sites')"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <div class="setting-group">
            <h4>üè∑Ô∏è Cat√©gories</h4>
            <div class="setting-list" id="catList"></div>
            <div class="setting-add">
                <input type="text" id="newCatInput" placeholder="Nouvelle cat...">
                <button class="btn-mini" onclick="addSetting('categories')"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <div style="height:20px;"></div>
        <button class="btn btn-primary" onclick="toggleSettings()">OK</button>
    </div>
</div>

<!-- SIDEBAR (LISTE) -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="top-bar">
            <span class="app-title">Journal Chantier</span>
            <button class="btn-settings" onclick="toggleSettings()"><i class="fas fa-cog"></i></button>
        </div>

        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Rechercher..." onkeyup="renderList()">
        </div>
        <div class="filter-row">
            <select id="filterCategory" onchange="renderList()"></select>
        </div>
        <div class="action-row">
            <button class="btn-mini" onclick="createNew()"><i class="fas fa-plus" style="color:var(--primary)"></i> Nouveau</button>
            <button class="btn-mini" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
            <button class="btn-mini" onclick="exportJSON()"><i class="fas fa-download"></i> Backup</button>
        </div>
        <div style="font-size: 0.75rem; color: #94a3b8; text-align: center; margin-top:10px;">
            <span id="countDisplay">0</span> fiches
        </div>
    </div>
    <div class="entry-list" id="entryList"></div>
</aside>

<!-- MAIN CONTENT (FORMULAIRE) -->
<main class="main-content" id="mainContent">
    <div class="form-container">
        <div class="header-edit">
            <button class="btn-mobile-back" onclick="closeMobileForm()"><i class="fas fa-chevron-left"></i></button>
            <h2 id="formTitle">Fiche</h2>
            <button id="deleteBtn" class="btn btn-danger hidden" onclick="deleteMainEntry()" style="padding: 8px 12px; font-size: 0.8rem;">Supprimer</button>
        </div>
        <input type="hidden" id="entryId">

        <div class="row">
            <div><label>Date</label><input type="datetime-local" id="entryDate"></div>
            <div><label>Rubrique</label><select id="entryCategory"></select></div>
        </div>
        <div class="row">
            <div><label>Lieu</label><select id="entrySite"></select></div>
            <div>
                <label>Avancement: <span id="progDisplay" style="color:var(--primary)">0%</span></label>
                <input type="range" id="entryProgress" min="0" max="100" step="10" value="0" style="width:100%" oninput="document.getElementById('progDisplay').innerText=this.value+'%'">
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label>Description</label>
            <textarea id="entryDesc" rows="5" placeholder="D√©tails..."></textarea>
        </div>

        <div class="photo-section">
            <label class="btn-file">
                <i class="fas fa-camera" style="color:var(--primary)"></i> Ajouter Photos
                <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handleMainPhotos(this)">
            </label>
            <div class="photo-gallery" id="mainPhotoGallery"></div>
        </div>

        <button class="btn btn-primary" onclick="saveMainEntry()">Enregistrer la fiche</button>

        <div id="timelineSection" class="timeline-section hidden">
            <div style="font-weight:800; margin-bottom:15px; font-size:1.1rem; color:#334155;">Fil d'actualit√©</div>
            <div class="timeline-input-box">
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <input type="text" id="updateText" placeholder="Ajouter une note de suivi...">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <input type="datetime-local" id="updateDate" style="width:auto; flex-grow:0;">
                        <div style="display:flex; gap:10px;">
                             <label class="btn-icon" style="cursor:pointer; font-size:1.5rem; color:var(--primary);">
                                <i class="fas fa-camera"></i>
                                <input type="file" accept="image/*" multiple style="display:none" onchange="handleUpdatePhotos(this)">
                            </label>
                            <button class="btn btn-success" style="width:auto; margin:0; padding: 8px 15px;" onclick="addUpdate()">Ajouter</button>
                        </div>
                    </div>
                </div>
                <div class="photo-gallery" id="updatePhotoPreview" style="margin-top:10px;"></div>
            </div>
            <div id="timelineList"></div>
        </div>
    </div>
</main>

<script>
    // --- MODE MOBILE ---
    function openMobileForm() { document.body.classList.add('view-form'); window.scrollTo(0,0); }
    function closeMobileForm() { document.body.classList.remove('view-form'); }

    // --- CONFIG & DATA ---
    const defaultSettings = {
        sites: ["B√¢timent A", "B√¢timent B", "Ext√©rieur"],
        categories: ["G√©n√©ral", "√âlectricit√©", "Plomberie", "Ma√ßonnerie"],
        pdfTitle: "Rapport de Chantier",
        logo: null
    };
    let appData = { settings: {...defaultSettings}, entries: [] };

    // --- INIT ---
    function initApp() {
        const raw = localStorage.getItem('journal_v10'); // New key for V10
        if (raw) { appData = JSON.parse(raw); appData.settings = {...defaultSettings, ...appData.settings}; }
        else {
            // Migration V7/V9 -> V10
            const old = localStorage.getItem('journalEntries_v7');
            if(old) { appData = JSON.parse(old); saveToStorage(); }
        }
        updateDropdowns(); setNow('entryDate'); renderList(); renderSettingsUI();
    }
    function saveToStorage() { localStorage.setItem('journal_v10', JSON.stringify(appData)); }

    // --- SETTINGS UI ---
    function toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); renderSettingsUI(); }
    function renderSettingsUI() {
        document.getElementById('pdfTitleInput').value = appData.settings.pdfTitle;
        const lp = document.getElementById('logoPreview');
        lp.innerHTML = appData.settings.logo ? `<img src="${appData.settings.logo}" style="width:100%;height:100%;object-fit:contain">` : `<i class="fas fa-image" style="color:#cbd5e1"></i>`;
        renderListSet('siteList', appData.settings.sites, 'sites');
        renderListSet('catList', appData.settings.categories, 'categories');
    }
    function renderListSet(id, arr, type) {
        document.getElementById(id).innerHTML = arr.map((item,i) => `
            <div class="setting-item"><span>${item}</span><button style="border:none;background:none;color:#ef4444" onclick="rmSet('${type}',${i})">&times;</button></div>
        `).join('');
    }
    function addSetting(type) {
        const val = document.getElementById(type === 'sites' ? 'newSiteInput' : 'newCatInput').value.trim();
        if(val && !appData.settings[type].includes(val)) { appData.settings[type].push(val); saveToStorage(); renderSettingsUI(); updateDropdowns(); }
    }
    function rmSet(type, i) { if(confirm("Supprimer ?")) { appData.settings[type].splice(i,1); saveToStorage(); renderSettingsUI(); updateDropdowns(); } }

    function savePdfSettings() { appData.settings.pdfTitle = document.getElementById('pdfTitleInput').value; saveToStorage(); }
    async function handleLogoUpload(input) { if(input.files[0]) { appData.settings.logo = await resizeImage(input.files[0], 300); saveToStorage(); renderSettingsUI(); } }
    function removeLogo() { if(confirm("Supprimer logo ?")) { appData.settings.logo = null; saveToStorage(); renderSettingsUI(); } }

    function updateDropdowns() {
        const opts = (arr) => arr.map(x => `<option value="${x}">${x}</option>`).join('');
        document.getElementById('entrySite').innerHTML = '<option disabled selected>Choisir...</option>' + opts(appData.settings.sites);
        document.getElementById('entryCategory').innerHTML = opts(appData.settings.categories);
        document.getElementById('filterCategory').innerHTML = '<option value="All">Tout</option>' + opts(appData.settings.categories);
    }

    // --- CORE LOGIC ---
    function resizeImage(file, max=800) {
        return new Promise(r => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    let w=img.width, h=img.height;
                    if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}
                    c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
                    r(c.toDataURL('image/jpeg', 0.7));
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        });
    }

    let tmpMain=[], tmpUp=[];
    async function handleMainPhotos(inp) { if(inp.files) for(let f of inp.files) tmpMain.push(await resizeImage(f)); renderGal('mainPhotoGallery', tmpMain, 'tmpMain'); inp.value=''; }
    async function handleUpdatePhotos(inp) { if(inp.files) for(let f of inp.files) tmpUp.push(await resizeImage(f)); renderGal('updatePhotoPreview', tmpUp, 'tmpUp'); inp.value=''; }

    function renderGal(id, arr, varName) {
        document.getElementById(id).innerHTML = arr.map((p,i) =>
            `<div class="photo-item"><img src="${p}"><button class="photo-del" onclick="${varName}.splice(${i},1);renderGal('${id}',${varName},'${varName}')">&times;</button></div>`
        ).join('');
    }

    let curId = null;
    function saveMainEntry() {
        const site = document.getElementById('entrySite').value;
        if(site === "Choisir...") return alert("Le site est requis");

        const entry = {
            id: curId || Date.now(),
            date: document.getElementById('entryDate').value,
            site: site,
            category: document.getElementById('entryCategory').value,
            progress: document.getElementById('entryProgress').value,
            description: document.getElementById('entryDesc').value,
            photos: [...tmpMain],
            updates: curId ? appData.entries.find(e=>e.id===curId).updates : []
        };

        if(curId) { const i = appData.entries.findIndex(e=>e.id===curId); appData.entries[i] = entry; }
        else { appData.entries.unshift(entry); curId = entry.id; }

        saveToStorage(); loadEntry(curId); renderList();
    }

    function loadEntry(id) {
        curId = id;
        const e = appData.entries.find(x => x.id === id);

        document.getElementById('entryDate').value = e.date;
        document.getElementById('entryCategory').value = e.category;
        document.getElementById('entryProgress').value = e.progress;
        document.getElementById('progDisplay').innerText = e.progress+'%';
        document.getElementById('entryDesc').value = e.description;

        // Site archiv√©
        const sSel = document.getElementById('entrySite');
        if(!appData.settings.sites.includes(e.site)) sSel.innerHTML += `<option value="${e.site}">${e.site} (Archiv√©)</option>`;
        sSel.value = e.site;

        tmpMain = [...e.photos||[]]; renderGal('mainPhotoGallery', tmpMain, 'tmpMain');

        document.getElementById('deleteBtn').classList.remove('hidden');
        document.getElementById('timelineSection').classList.remove('hidden');
        renderTimeline(e.updates||[]);

        tmpUp=[]; renderGal('updatePhotoPreview', tmpUp, 'tmpUp');
        setNow('updateDate'); document.getElementById('updateText').value='';

        openMobileForm();
    }

    function createNew() {
        curId = null; tmpMain=[]; renderGal('mainPhotoGallery', tmpMain, 'tmpMain');
        document.getElementById('deleteBtn').classList.add('hidden');
        document.getElementById('timelineSection').classList.add('hidden');
        document.getElementById('entrySite').value = 'Choisir...';
        document.getElementById('entryDesc').value = '';
        document.getElementById('entryProgress').value = 0;
        document.getElementById('progDisplay').innerText = "0%";
        setNow('entryDate');
        openMobileForm();
    }

    function deleteMainEntry() {
        if(confirm("Supprimer ?")) {
            appData.entries = appData.entries.filter(e => e.id !== curId);
            saveToStorage(); renderList(); closeMobileForm();
        }
    }

    function addUpdate() {
        if(!curId) return;
        const txt = document.getElementById('updateText').value;
        if(!txt && tmpUp.length===0) return;
        const e = appData.entries.find(x => x.id === curId);
        if(!e.updates) e.updates = [];
        e.updates.unshift({ id:Date.now(), date:document.getElementById('updateDate').value||new Date().toISOString(), text:txt, photos:[...tmpUp] });
        saveToStorage();
        document.getElementById('updateText').value=''; tmpUp=[]; renderGal('updatePhotoPreview', tmpUp, 'tmpUp');
        renderTimeline(e.updates); renderList();
    }

    function renderTimeline(updates) {
        document.getElementById('timelineList').innerHTML = updates.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(u => {
            const imgs = (u.photos||[]).map(p=>`<img src="${p}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #eee" onclick="window.open('${p}')">`).join('');
            return `<div class="timeline-item">
                <div style="font-size:0.75rem;color:#64748b;margin-bottom:4px;display:flex;justify-content:space-between">
                    ${new Date(u.date).toLocaleDateString()} ${new Date(u.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
                    <i class="fas fa-trash" style="cursor:pointer" onclick="delUp(${u.id})"></i>
                </div>
                <div style="background:white;padding:12px;border:1px solid #e2e8f0;border-radius:8px;">
                    <div>${u.text}</div>
                    <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap">${imgs}</div>
                </div>
            </div>`;
        }).join('');
    }
    function delUp(uid) {
        if(!confirm("Supprimer ?")) return;
        const e = appData.entries.find(x => x.id === curId);
        e.updates = e.updates.filter(u => u.id !== uid);
        saveToStorage(); renderTimeline(e.updates);
    }

    function renderList() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('filterCategory').value;
        const list = document.getElementById('entryList');

        const res = appData.entries.filter(e =>
            (e.site.toLowerCase().includes(search) || e.description.toLowerCase().includes(search)) &&
            (cat === 'All' || e.category === cat)
        ).sort((a,b) => new Date(b.date) - new Date(a.date));

        document.getElementById('countDisplay').innerText = res.length;
        list.innerHTML = res.map(e => {
            let pCount = (e.photos?.length||0) + (e.updates?.reduce((acc,u)=>acc+(u.photos?.length||0),0)||0);
            return `<div class="entry-card ${curId===e.id?'active':''}" onclick="loadEntry(${e.id})">
                <div class="card-header"><span>${new Date(e.date).toLocaleDateString()}</span><span>${e.progress}%</span></div>
                <div class="card-title">${e.site}</div>
                <div class="card-preview">${e.description}</div>
                <div style="font-size:0.75rem;margin-top:8px;color:#64748b">
                    ${pCount>0?`<i class="fas fa-camera" style="color:#2563eb"></i> ${pCount}`:''}
                    ${e.updates?.length>0?`<i class="fas fa-history" style="color:#10b981;margin-left:8px"></i> ${e.updates.length}`:''}
                </div>
            </div>`;
        }).join('');
    }

    // --- PDF ---
    function exportPDF() {
        const doc = new window.jspdf.jsPDF();
        const title = appData.settings.pdfTitle || "Rapport";

        doc.setFillColor(37, 99, 235); doc.rect(0,0,210,35,'F');
        doc.setTextColor(255); doc.setFontSize(18);
        if(appData.settings.logo) { try{ doc.addImage(appData.settings.logo,'JPEG',10,5,25,25); }catch(e){} doc.text(title,40,22); }
        else { doc.text(title,10,22); }

        let y=45;
        appData.entries.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e => {
            if(y>250){doc.addPage();y=20;}
            doc.setFillColor(240); doc.rect(10,y,190,8,'F');
            doc.setTextColor(0); doc.setFontSize(11); doc.setFont("helvetica","bold");
            doc.text(`${new Date(e.date).toLocaleDateString()} | ${e.site}`, 12, y+6);
            y+=14;

            doc.setFont("helvetica","normal"); doc.setFontSize(10);
            const lines = doc.splitTextToSize(e.description, 180);
            doc.text(lines, 12, y); y += (lines.length*5)+5;

            if(e.photos?.length) {
                let x=12; e.photos.forEach(p=>{
                    if(x>170){x=12;y+=35;} if(y>250){doc.addPage();y=20;}
                    try{doc.addImage(p,'JPEG',x,y,30,30);x+=35;}catch(err){}
                }); y+=35;
            }
            if(e.updates?.length) {
                e.updates.forEach(u=>{
                   if(y>270){doc.addPage();y=20;}
                   doc.setTextColor(100); doc.setFontSize(9);
                   doc.text(`‚Ä¢ ${new Date(u.date).toLocaleDateString()}: ${u.text}`, 15, y); y+=5;
                }); y+=5;
            }
            doc.setDrawColor(200); doc.line(10,y,200,y); y+=10;
        });
        doc.save("rapport.pdf");
    }

    // UTILS
    function setNow(id) { const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); document.getElementById(id).value=d.toISOString().slice(0,16); }
    function exportJSON() {
        const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData));
        a.download="backup.json"; document.body.appendChild(a); a.click(); a.remove();
    }

    initApp();
</script>
</body>
</html>
