<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Journal">
    <meta name="theme-color" content="#f2f2f7">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAnUExURQAAACVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj65/L52UAAAAMdFJOUwAQHz9Azt9vj+D/y0wtOvwAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACwSURBVHhe7cExAQAAAMKg9U9tCy8gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIB3A8VHAAEdjagAAAAASUVORK5CYII=">

    <title>Journal Chantier</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #007AFF;
            --bg-app: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #000000;
            --text-sec: #8E8E93;
            --border: #C6C6C8;
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-app); color: var(--text-main); height: 100dvh; width: 100vw; overflow: hidden; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        * { box-sizing: border-box; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }

        /* --- VUES --- */
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-app); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1); padding-top: var(--safe-top); padding-bottom: calc(60px + var(--safe-bottom)); z-index: 10; }
        .view.hidden-right { transform: translateX(100%); pointer-events: none; }
        .view.active { transform: translateX(0); }
        .view.hidden-left { transform: translateX(-30%); opacity: 0.8; }

        /* --- MODAL --- */
        .view-modal { position: fixed; z-index: 9999; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1); padding-bottom: var(--safe-bottom); background: var(--bg-app); border-top-left-radius: 15px; border-top-right-radius: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .view-modal.active { transform: translateY(0); }
        .modal-handle { width: 40px; height: 5px; background: #C5C5C7; border-radius: 3px; margin: 8px auto 0 auto; }

        /* --- HEADER --- */
        .nav-bar { height: 50px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: rgba(242, 242, 247, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 50; }
        .nav-title { font-size: 17px; font-weight: 600; text-align: center; flex-grow: 1; }
        .nav-btn { color: var(--primary); font-size: 17px; background: none; border: none; cursor: pointer; padding: 10px 5px; }
        .nav-btn.danger { color: var(--danger); }
        .nav-btn.icon { font-size: 20px; width: 40px; display:flex; justify-content:flex-end; }

        /* --- CONTENT --- */
        .content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding: 15px; -webkit-overflow-scrolling: touch; padding-bottom: 100px; }

        /* --- UI ELEMENTS --- */
        .search-container { background: #e3e3e8; border-radius: 10px; padding: 8px 12px; margin-bottom: 10px; }
        .search-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .search-bar input { border: none; background: transparent; font-size: 17px; width: 100%; outline: none; }
        .date-filter-row { display: flex; gap: 10px; align-items: center; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 8px; }
        .date-filter-row input { background: rgba(255,255,255,0.5); border: none; border-radius: 6px; padding: 4px 8px; font-size: 13px; width: 100%; color: var(--text-main); }

        .journal-card { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
        .journal-card:active { background: #f2f2f2; transform: scale(0.98); transition: 0.1s; }

        .j-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; color: var(--text-sec); }
        .j-title { font-size: 17px; font-weight: 600; margin-bottom: 4px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-todo { background: #8E8E93; }
        .status-doing { background: var(--primary); }
        .status-blocked { background: var(--warning); }
        .status-done { background: var(--success); }

        .j-desc { font-size: 15px; color: #3A3A3C; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .j-footer { margin-top: 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .j-badges { display: flex; gap: 10px; font-size: 12px; color: var(--text-sec); }
        .badge { background: #E5E5EA; padding: 3px 8px; border-radius: 6px; display: flex; align-items: center; gap: 4px; font-weight: 500; }
        .badge.blue { color: var(--primary); background: rgba(0,122,255,0.1); }
        .btn-pdf-mini { background: rgba(255, 59, 48, 0.1); color: var(--danger); border: 1px solid rgba(255, 59, 48, 0.2); padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }

        /* --- FORM --- */
        .ios-list { background: var(--bg-card); border-radius: 12px; overflow: hidden; margin-bottom: 25px; }
        .ios-item { padding: 12px 16px; border-bottom: 1px solid #E5E5EA; display: flex; flex-direction: column; gap: 6px; }
        .ios-item:last-child { border-bottom: none; }
        .ios-label { font-size: 12px; font-weight: 500; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
        .ios-input { font-size: 17px; border: none; width: 100%; outline: none; background: transparent; padding: 4px 0; font-family: inherit; }
        select.ios-input { background-color: transparent; }
        textarea.ios-input { min-height: 100px; resize: none; line-height: 1.4; }

        /* Weather & Status */
        .weather-row { display: flex; gap: 10px; margin-top: 5px; }
        .weather-opt { flex: 1; text-align: center; padding: 6px; border: 1px solid #E5E5EA; border-radius: 8px; cursor: pointer; color: #8E8E93; transition: 0.2s; font-size: 18px; }
        .weather-opt.selected { background: rgba(0,122,255,0.1); border-color: var(--primary); color: var(--primary); }

        .status-pill-container { display: flex; gap: 8px; margin-top: 5px; }
        .status-pill { flex: 1; text-align: center; padding: 8px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; opacity: 0.4; transition: 0.2s; border: 1px solid transparent; }
        .status-pill.s-todo { background: #E5E5EA; color: #333; }
        .status-pill.s-doing { background: rgba(0,122,255,0.2); color: var(--primary); }
        .status-pill.s-blocked { background: rgba(255,149,0,0.2); color: var(--warning); }
        .status-pill.s-done { background: rgba(52,199,89,0.2); color: var(--success); }
        .status-pill.active { opacity: 1; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-color: currentColor; }

        .h-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; }
        .photo-thumb { width: 90px; height: 90px; flex-shrink: 0; border-radius: 10px; overflow: hidden; position: relative; background: #eee; }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .btn-del-photo { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .add-photo-btn { width: 90px; height: 90px; flex-shrink: 0; border-radius: 10px; border: 2px dashed #C6C6C8; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); font-size: 12px; font-weight: 600; cursor: pointer; background: rgba(255,255,255,0.5); }

        /* Timeline */
        .timeline { margin-left: 20px; border-left: 2px solid #E5E5EA; padding-left: 20px; }
        .t-item { position: relative; padding-bottom: 25px; transition: background 0.2s; }
        .t-item.editing { background: #fffde7; padding: 10px; border-radius: 8px; margin-left: -10px; border: 1px dashed orange; }
        .t-item::before { content:''; position: absolute; left: -26px; top: 4px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px #E5E5EA; }
        .t-date { font-size: 12px; color: var(--text-sec); margin-bottom: 6px; display: flex; justify-content: space-between; }
        .t-text { font-size: 16px; background: white; padding: 12px; border-radius: 10px; border: 1px solid #E5E5EA; line-height: 1.4; }
        .t-actions { display: flex; gap: 15px; }

        /* Settings */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-bottom: 1px solid #E5E5EA; }
        .setting-group { margin-bottom: 25px; border-radius: 12px; overflow: hidden; }
        .setting-header { padding: 0 0 8px 16px; font-size: 13px; color: var(--text-sec); text-transform: uppercase; }

        /* Menu */
        .dropdown-menu { position: absolute; top: 55px; right: 15px; width: 240px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 200; display: none; transform-origin: top right; border: 1px solid rgba(0,0,0,0.1); }
        .dropdown-menu.show { display: block; animation: popIn 0.2s; }
        .menu-item { padding: 14px 18px; border-bottom: 1px solid #E5E5EA; display: flex; align-items: center; gap: 12px; font-size: 17px; color: var(--text-main); background: none; border: none; width: 100%; text-align: left; }
        .menu-item:last-child { border-bottom: none; }
        @keyframes popIn { from { opacity:0; transform: scale(0.9); } to { opacity:1; transform: scale(1); } }

        /* Tab Bar */
        .tab-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: calc(55px + var(--safe-bottom)); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.15); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 8px; z-index: 100; }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sec); text-decoration: none; font-size: 10px; font-weight: 500; background: none; border: none; cursor: pointer; width: 60px; -webkit-tap-highlight-color: transparent; }
        .tab-item i { font-size: 24px; margin-bottom: 4px; }
        .tab-item.active { color: var(--primary); }
        .tab-item.big-add { transform: translateY(-20px); }
        .tab-item.big-add div { width: 54px; height: 54px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,122,255,0.4); }
        .tab-item.big-add i { font-size: 26px; margin: 0; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- === VIEW 1: LISTE === -->
    <div id="viewList" class="view active">
        <div class="nav-bar">
            <div style="width:40px"></div>
            <div class="nav-title">Journal</div>
            <button class="nav-btn icon" onclick="toggleExportMenu()"><i class="fas fa-share-square"></i></button>
        </div>
        <div id="exportMenu" class="dropdown-menu">
            <button class="menu-item" onclick="exportPDF(null);toggleExportMenu()"><i class="fas fa-file-pdf" style="color:#FF3B30"></i> Rapport Complet</button>
            <button class="menu-item" onclick="exportJSON();toggleExportMenu()"><i class="fas fa-file-code" style="color:#34C759"></i> Sauvegarde JSON</button>
            <label class="menu-item" style="cursor:pointer; color:var(--primary)">
                <i class="fas fa-upload"></i> Restaurer Sauvegarde
                <input type="file" accept=".json" style="display:none" onchange="importJSON(this)">
            </label>
        </div>
        <div class="content">
            <div class="search-container">
                <div class="search-bar">
                    <i class="fas fa-search" style="color:#8E8E93"></i>
                    <input type="text" id="searchInput" placeholder="Rechercher..." onkeyup="renderList()">
                    <select id="filterCategory" onchange="renderList()" style="width:auto; border:none; background:none; color:var(--primary); font-weight:600; font-size:15px;">
                        <option value="All">Tout</option>
                    </select>
                </div>
                <div class="date-filter-row">
                    <input type="date" id="dateStart" onchange="renderList()" placeholder="Du...">
                    <span style="color:#8E8E93; font-size:12px">au</span>
                    <input type="date" id="dateEnd" onchange="renderList()" placeholder="Au...">
                </div>
            </div>
            <div style="font-size:13px; color:#8E8E93; margin:0 0 10px 5px;"><span id="countDisplay">0</span> fiches</div>
            <div id="entryList"></div>
            <div style="height: 60px;"></div>
        </div>
    </div>

    <!-- === VIEW 2: FORMULAIRE === -->
    <div id="viewForm" class="view hidden-right" style="z-index: 15;">
        <div class="nav-bar">
            <button class="nav-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i> Retour</button>
            <div class="nav-title" id="formTitle">Fiche</div>
            <button class="nav-btn" onclick="saveEntry()" style="font-weight:700; font-size:17px">Enregistrer</button>
        </div>
        <div class="content">
            <input type="hidden" id="entryId">

            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">Statut</span>
                    <div class="status-pill-container" id="statusSelector">
                        <div class="status-pill s-todo" onclick="setStatus('todo')">√Ä faire</div>
                        <div class="status-pill s-doing" onclick="setStatus('doing')">En cours</div>
                        <div class="status-pill s-blocked" onclick="setStatus('blocked')">Bloqu√©</div>
                        <div class="status-pill s-done" onclick="setStatus('done')">Termin√©</div>
                    </div>
                </div>
                <div class="ios-item">
                    <span class="ios-label">Date et Heure</span>
                    <input type="datetime-local" id="entryDate" class="ios-input">
                </div>
                <div class="ios-item">
                    <span class="ios-label">M√©t√©o & Temp√©rature</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="weather-row" id="weatherSelector" style="flex:1">
                            <div class="weather-opt" onclick="setWeather('sun')">‚òÄÔ∏è</div>
                            <div class="weather-opt" onclick="setWeather('cloud')">‚òÅÔ∏è</div>
                            <div class="weather-opt" onclick="setWeather('rain')">üåßÔ∏è</div>
                            <div class="weather-opt" onclick="setWeather('snow')">‚ùÑÔ∏è</div>
                        </div>
                        <input type="number" id="entryTemp" class="ios-input" placeholder="¬∞C" style="width:60px; text-align:center; border:1px solid #E5E5EA; border-radius:8px; padding:8px;">
                    </div>
                </div>
            </div>

            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">Lieu / Site</span>
                    <select id="entrySite" class="ios-input"></select>
                </div>
                <div class="ios-item">
                    <span class="ios-label">Rubrique</span>
                    <select id="entryCategory" class="ios-input"></select>
                </div>
                <div class="ios-item">
                    <span class="ios-label">Avancement: <span id="progDisplay" style="color:var(--primary); font-weight:600">0%</span></span>
                    <input type="range" id="entryProgress" min="0" max="100" step="10" value="0" style="width:100%; margin-top:10px" oninput="document.getElementById('progDisplay').innerText=this.value+'%'">
                </div>
            </div>

            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">Description</span>
                    <textarea id="entryDesc" class="ios-input" placeholder="Notes, observations..."></textarea>
                </div>
                <div class="ios-item">
                    <span class="ios-label" style="margin-bottom:10px">Photos</span>
                    <div class="h-scroll">
                        <label class="add-photo-btn">
                            <i class="fas fa-camera fa-2x"></i>
                            <span style="margin-top:4px">Ajouter</span>
                            <input type="file" multiple accept="image/*" style="display:none" onchange="handleMainPhotos(this)">
                        </label>
                        <div id="mainPhotoGallery" style="display:flex; gap:10px"></div>
                    </div>
                </div>
            </div>

            <div id="timelineSection" class="hidden">
                <h4 style="margin:20px 0 10px 10px; color:var(--text-sec); text-transform:uppercase; font-size:13px;">Historique & Suivi</h4>
                <div class="ios-list" style="margin-bottom:15px; border:1px solid var(--primary); background:#f0f9ff" id="updateFormBox">
                    <div class="ios-item">
                         <span class="ios-label" style="color:var(--primary)" id="updateFormLabel">Ajouter un suivi</span>
                         <div style="display:flex; gap:10px; margin-bottom:5px">
                            <input type="datetime-local" id="updateDate" class="ios-input" style="color:var(--text-main); font-size:14px; width:auto">
                            <!-- Weather Timeline -->
                            <div class="weather-row" id="updateWeatherSelector" style="flex:1; margin-top:0">
                                <div class="weather-opt" style="padding:2px; font-size:16px" onclick="setUpdateWeather('sun')">‚òÄÔ∏è</div>
                                <div class="weather-opt" style="padding:2px; font-size:16px" onclick="setUpdateWeather('cloud')">‚òÅÔ∏è</div>
                                <div class="weather-opt" style="padding:2px; font-size:16px" onclick="setUpdateWeather('rain')">üåßÔ∏è</div>
                                <div class="weather-opt" style="padding:2px; font-size:16px" onclick="setUpdateWeather('snow')">‚ùÑÔ∏è</div>
                            </div>
                            <input type="number" id="updateTemp" class="ios-input" placeholder="¬∞C" style="width:40px; text-align:center; border-bottom:1px solid #ddd; font-size:14px">
                         </div>
                         <div style="display:flex; align-items:center; gap:10px">
                             <input type="text" id="updateText" class="ios-input" placeholder="Note de suivi..." style="flex-grow:1; border-bottom:1px solid #eee">
                             <label style="color:var(--primary); cursor:pointer"><i class="fas fa-camera" style="font-size:20px"></i><input type="file" multiple accept="image/*" style="display:none" onchange="handleUpdatePhotos(this)"></label>
                             <button id="btnSaveUpdate" onclick="saveUpdate()" style="background:var(--success); color:white; border:none; border-radius:15px; width:32px; height:32px; display:flex; align-items:center; justify-content:center"><i class="fas fa-arrow-up"></i></button>
                         </div>
                    </div>
                    <div id="updatePhotoPreview" class="h-scroll" style="padding:0 15px 10px 15px;"></div>
                </div>
                <div class="timeline" id="timelineList"></div>
            </div>

            <button id="deleteBtn" class="nav-btn danger" style="width:100%; margin-top:20px; padding:15px; background:white; border-radius:12px; font-weight:600" onclick="deleteEntry()">Supprimer cette fiche</button>
            <div style="height: 100px;"></div>
        </div>
    </div>

    <!-- === VIEW 3: SETTINGS === -->
    <div id="viewSettings" class="view view-modal">
        <div class="modal-handle"></div>
        <div class="nav-bar" style="background:transparent; border:none;">
            <div class="nav-title">R√©glages</div>
            <button class="nav-btn" onclick="closeSettings()" style="position:absolute; right:15px; font-weight:700; background:#E5E5EA; border-radius:50%; width:30px; height:30px; padding:0; display:flex; align-items:center; justify-content:center; color:#8E8E93"><i class="fas fa-times"></i></button>
        </div>
        <div class="content">
            <div class="setting-header">PDF</div>
            <div class="setting-group">
                <div class="setting-row">
                    <span>Titre</span>
                    <input type="text" id="pdfTitleInput" onchange="savePdfSettings()" style="text-align:right; border:none; color:var(--primary); outline:none; font-size:17px" placeholder="Rapport...">
                </div>
                <div class="setting-row">
                    <span>Couleur Th√®me</span>
                    <input type="color" id="pdfColorInput" onchange="savePdfSettings()" style="border:none; background:none; height:30px; width:50px; padding:0; -webkit-appearance:none;">
                </div>
                <div class="setting-row">
                    <span>Logo</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div id="logoPreview" style="width:40px; height:40px; background:#eee; border-radius:6px; overflow:hidden"></div>
                        <label style="color:var(--primary); cursor:pointer">Choisir<input type="file" accept="image/*" style="display:none" onchange="handleLogoUpload(this)"></label>
                        <button onclick="removeLogo()" style="border:none; background:none; color:var(--danger); font-size:18px"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
            <div class="setting-header">Configuration</div>
            <div class="setting-group">
                <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:10px">
                    <div style="display:flex; justify-content:space-between"><strong>Lieux / Sites</strong></div>
                    <div id="siteList" style="display:flex; flex-wrap:wrap; gap:8px"></div>
                    <div style="display:flex; gap:10px; margin-top:5px">
                        <input type="text" id="newSiteInput" placeholder="Nouveau..." style="flex:1; border:1px solid #ddd; border-radius:8px; padding:8px; font-size:16px;">
                        <button onclick="addSetting('sites')" style="background:var(--primary); color:white; border:none; border-radius:8px; padding:0 12px; font-weight:600">OK</button>
                    </div>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:10px">
                    <div style="display:flex; justify-content:space-between"><strong>Rubriques</strong></div>
                    <div id="catList" style="display:flex; flex-wrap:wrap; gap:8px"></div>
                    <div style="display:flex; gap:10px; margin-top:5px">
                        <input type="text" id="newCatInput" placeholder="Nouvelle..." style="flex:1; border:1px solid #ddd; border-radius:8px; padding:8px; font-size:16px;">
                        <button onclick="addSetting('categories')" style="background:var(--primary); color:white; border:none; border-radius:8px; padding:0 12px; font-weight:600">OK</button>
                    </div>
                </div>
            </div>
            <div style="text-align:center; font-size:12px; color:var(--text-sec); margin-top:20px">Version 17.0 (Color Picker)</div>
            <div style="height:100px"></div>
        </div>
    </div>

    <!-- === TAB BAR === -->
    <div class="tab-bar">
        <button class="tab-item active" onclick="goHome()">
            <i class="fas fa-list-ul"></i>
            <span>Journal</span>
        </button>
        <button class="tab-item big-add" onclick="createNew()">
            <div><i class="fas fa-plus"></i></div>
        </button>
        <button class="tab-item" onclick="openSettings()">
            <i class="fas fa-cog"></i>
            <span>R√©glages</span>
        </button>
    </div>

    <script>
        // --- NAVIGATION ---
        function goHome() {
            document.getElementById('viewList').classList.remove('hidden-left');
            document.getElementById('viewList').classList.add('active');
            document.getElementById('viewForm').classList.remove('active');
            document.getElementById('viewForm').classList.add('hidden-right');
            closeSettings();
        }

        function goBack() { goHome(); }

        function openForm() {
            document.getElementById('viewList').classList.remove('active');
            document.getElementById('viewList').classList.add('hidden-left');
            document.getElementById('viewForm').classList.remove('hidden-right');
            document.getElementById('viewForm').classList.add('active');
        }

        function openSettings() { document.getElementById('viewSettings').classList.add('active'); }
        function closeSettings() { document.getElementById('viewSettings').classList.remove('active'); }

        function toggleExportMenu() { document.getElementById('exportMenu').classList.toggle('show'); }
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('exportMenu');
            const btn = document.querySelector('.nav-btn.icon');
            if (!menu.contains(event.target) && !btn.contains(event.target) && menu.classList.contains('show')) {
                menu.classList.remove('show');
            }
        });

        // --- DATA ---
        const defaultSettings = {
            sites: ["B√¢timent A", "B√¢timent B", "Ext√©rieur"],
            categories: ["G√©n√©ral", "√âlectricit√©", "Plomberie", "Ma√ßonnerie"],
            pdfTitle: "Rapport de Chantier",
            pdfColor: "#007AFF", // Default Apple Blue
            logo: null
        };
        let appData = { settings: {...defaultSettings}, entries: [] };

        let currentStatus = 'todo';
        let currentWeather = null;
        let currentUpdateWeather = null;
        let editingUpdateId = null;

        function initApp() {
            const raw = localStorage.getItem('journal_v14'); // Keep V14 key for now
            if (raw) {
                appData = JSON.parse(raw);
                appData.settings = {...defaultSettings, ...appData.settings};
            }
            updateDropdowns(); renderList();

            document.getElementById('pdfTitleInput').value = appData.settings.pdfTitle;
            document.getElementById('pdfColorInput').value = appData.settings.pdfColor || "#007AFF";
            renderLogoPreview();
            renderChips('siteList', appData.settings.sites, 'sites');
            renderChips('catList', appData.settings.categories, 'categories');
        }

        function saveToStorage() { localStorage.setItem('journal_v14', JSON.stringify(appData)); }

        // --- IMPORT JSON ---
        function importJSON(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data && data.entries) {
                        if(confirm("Attention: Cela va remplacer les donn√©es actuelles. Continuer ?")) {
                            appData = data;
                            if(!appData.settings) appData.settings = {...defaultSettings};
                            saveToStorage();
                            initApp();
                            alert("Restauration r√©ussie !");
                        }
                    } else {
                        alert("Fichier invalide");
                    }
                } catch(err) { alert("Erreur de lecture du fichier"); }
            };
            reader.readAsText(file);
            input.value = ''; // Reset
        }

        // --- UI HELPERS ---
        function setStatus(s) {
            currentStatus = s;
            document.querySelectorAll('#statusSelector .status-pill').forEach(el => el.classList.remove('active'));
            document.querySelector(`#statusSelector .status-pill.s-${s}`).classList.add('active');
        }

        function setWeather(w) {
            currentWeather = w;
            document.querySelectorAll('#weatherSelector .weather-opt').forEach(el => el.classList.remove('selected'));
            if(w) {
                const types = ['sun', 'cloud', 'rain', 'snow'];
                const idx = types.indexOf(w);
                if(idx >= 0) document.querySelectorAll('#weatherSelector .weather-opt')[idx].classList.add('selected');
            }
        }

        function setUpdateWeather(w) {
            currentUpdateWeather = w;
            document.querySelectorAll('#updateWeatherSelector .weather-opt').forEach(el => el.classList.remove('selected'));
            if(w) {
                const types = ['sun', 'cloud', 'rain', 'snow'];
                const idx = types.indexOf(w);
                if(idx >= 0) document.querySelectorAll('#updateWeatherSelector .weather-opt')[idx].classList.add('selected');
            }
        }

        function getWeatherIcon(w) {
            if(w=='sun') return '‚òÄÔ∏è'; if(w=='cloud') return '‚òÅÔ∏è'; if(w=='rain') return 'üåßÔ∏è'; if(w=='snow') return '‚ùÑÔ∏è';
            return '';
        }

        // --- LIST & FILTER ---
        function renderList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('filterCategory').value;
            const dStart = document.getElementById('dateStart').value;
            const dEnd = document.getElementById('dateEnd').value;

            const res = appData.entries.filter(e => {
                const matchesText = (e.site.toLowerCase().includes(search) || e.description.toLowerCase().includes(search));
                const matchesCat = (cat === 'All' || e.category === cat);
                let matchesDate = true;
                const entryDate = e.date.substring(0,10);
                if(dStart && entryDate < dStart) matchesDate = false;
                if(dEnd && entryDate > dEnd) matchesDate = false;
                return matchesText && matchesCat && matchesDate;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            document.getElementById('countDisplay').innerText = res.length;

            document.getElementById('entryList').innerHTML = res.map(e => {
                const pCount = (e.photos?.length||0);
                const uCount = (e.updates?.length||0);
                const dateObj = new Date(e.date);
                const statusColor = e.status === 'done' ? 'status-done' : (e.status === 'blocked' ? 'status-blocked' : (e.status === 'doing' ? 'status-doing' : 'status-todo'));

                return `
                <div class="journal-card" onclick="loadEntry(${e.id})">
                    <div class="j-header">
                        <span>${dateObj.getDate()} ${dateObj.toLocaleString('default', { month: 'short' })} ‚Ä¢ ${dateObj.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                        <div style="display:flex; align-items:center; gap:6px">
                            ${e.weather ? `<span>${getWeatherIcon(e.weather)}</span>` : ''}
                            <span style="color:var(--primary);font-weight:600">${e.progress}%</span>
                        </div>
                    </div>
                    <div class="j-title">
                        <span class="status-dot ${statusColor}"></span>
                        ${e.site}
                        <span style="font-weight:400; color:var(--text-sec); font-size:14px">(${e.category})</span>
                    </div>
                    <div class="j-desc">${e.description}</div>
                    <div class="j-footer">
                        <div class="j-badges">
                            ${pCount ? `<div class="badge blue"><i class="fas fa-camera"></i> ${pCount}</div>` : ''}
                            ${uCount ? `<div class="badge"><i class="fas fa-history"></i> ${uCount}</div>` : ''}
                        </div>
                        <button class="btn-pdf-mini" onclick="event.stopPropagation(); exportPDF(${e.id})">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- CRUD MAIN ---
        let curId = null;
        let tmpMain=[], tmpUp=[];

        function createNew() {
            curId = null; tmpMain=[]; resetUpdateForm();
            document.getElementById('formTitle').innerText = "Nouvelle Fiche";
            document.getElementById('entrySite').value = '';
            document.getElementById('entryDesc').value = '';
            document.getElementById('entryProgress').value = 0; document.getElementById('progDisplay').innerText="0%";
            document.getElementById('entryTemp').value = '';
            setStatus('todo'); setWeather(null);

            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('timelineSection').classList.add('hidden');

            setNow('entryDate');
            renderGal('mainPhotoGallery', tmpMain, 'tmpMain');
            openForm();
        }

        function loadEntry(id) {
            curId = id;
            const e = appData.entries.find(x => x.id === id);

            document.getElementById('formTitle').innerText = "D√©tails";
            document.getElementById('entryDate').value = e.date;
            document.getElementById('entryCategory').value = e.category;
            document.getElementById('entryProgress').value = e.progress;
            document.getElementById('progDisplay').innerText = e.progress+'%';
            document.getElementById('entryDesc').value = e.description;
            document.getElementById('entryTemp').value = e.temp || '';

            setStatus(e.status || 'todo');
            setWeather(e.weather || null);

            const sSel = document.getElementById('entrySite');
            if(![...sSel.options].some(o => o.value === e.site)) {
                 const opt = document.createElement('option'); opt.value = e.site; opt.text = e.site + " (Archiv√©)"; sSel.add(opt);
            }
            sSel.value = e.site;

            tmpMain = [...e.photos||[]]; renderGal('mainPhotoGallery', tmpMain, 'tmpMain');
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('timelineSection').classList.remove('hidden');
            renderTimeline(e.updates||[]);

            resetUpdateForm();
            openForm();
        }

        function saveEntry() {
            const site = document.getElementById('entrySite').value;
            if(!site) return alert("Choisissez un lieu");

            const entry = {
                id: curId || Date.now(),
                date: document.getElementById('entryDate').value,
                site: site,
                category: document.getElementById('entryCategory').value,
                progress: document.getElementById('entryProgress').value,
                description: document.getElementById('entryDesc').value,
                status: currentStatus,
                weather: currentWeather,
                temp: document.getElementById('entryTemp').value,
                photos: [...tmpMain],
                updates: curId ? appData.entries.find(e=>e.id===curId).updates : []
            };

            if(curId) { const i = appData.entries.findIndex(e=>e.id===curId); appData.entries[i] = entry; }
            else { appData.entries.unshift(entry); curId = entry.id; }

            saveToStorage(); goHome(); renderList();
        }

        function deleteEntry() {
            if(confirm("Supprimer ?")) {
                appData.entries = appData.entries.filter(e => e.id !== curId);
                saveToStorage(); goHome(); renderList();
            }
        }

        // --- MEDIA ---
        function resizeImage(file, max=800) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        let w=img.width, h=img.height;
                        if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}
                        c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
                        r(c.toDataURL('image/jpeg', 0.6));
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            });
        }

        async function handleMainPhotos(inp) { if(inp.files) for(let f of inp.files) tmpMain.push(await resizeImage(f)); renderGal('mainPhotoGallery', tmpMain, 'tmpMain'); inp.value=''; }
        async function handleUpdatePhotos(inp) { if(inp.files) for(let f of inp.files) tmpUp.push(await resizeImage(f)); renderGal('updatePhotoPreview', tmpUp, 'tmpUp'); inp.value=''; }

        function renderGal(id, arr, varName) {
            document.getElementById(id).innerHTML = arr.map((p,i) =>
                `<div class="photo-thumb"><img src="${p}" onclick="window.open('${p}')"><button class="btn-del-photo" onclick="${varName}.splice(${i},1);renderGal('${id}',${varName},'${varName}')">&times;</button></div>`
            ).join('');
        }

        // --- TIMELINE CRUD ---
        function resetUpdateForm() {
            tmpUp = [];
            editingUpdateId = null;
            document.getElementById('updateText').value = '';
            document.getElementById('updateTemp').value = '';
            setUpdateWeather(null);
            setNow('updateDate');
            renderGal('updatePhotoPreview', tmpUp, 'tmpUp');

            document.getElementById('updateFormLabel').innerText = "Ajouter un suivi";
            document.getElementById('updateFormBox').style.background = "#f0f9ff";
            document.getElementById('btnSaveUpdate').innerHTML = '<i class="fas fa-arrow-up"></i>';
        }

        function editUpdate(uid) {
            const e = appData.entries.find(x => x.id === curId);
            const u = e.updates.find(up => up.id === uid);
            if(!u) return;

            editingUpdateId = uid;
            document.getElementById('updateText').value = u.text;
            document.getElementById('updateDate').value = u.date;
            document.getElementById('updateTemp').value = u.temp || '';
            setUpdateWeather(u.weather || null);
            tmpUp = [...(u.photos || [])];
            renderGal('updatePhotoPreview', tmpUp, 'tmpUp');

            document.getElementById('updateFormLabel').innerText = "Modifier le suivi";
            document.getElementById('updateFormBox').style.background = "#fffde7";
            document.getElementById('btnSaveUpdate').innerHTML = '<i class="fas fa-check"></i>';
            document.getElementById('updateText').focus();
        }

        function saveUpdate() {
            if(!curId) return;
            const txt = document.getElementById('updateText').value;
            const date = document.getElementById('updateDate').value;

            if(!txt && tmpUp.length===0 && !editingUpdateId) return;

            const e = appData.entries.find(x => x.id === curId);
            if(!e.updates) e.updates = [];

            const updateObj = {
                id: editingUpdateId || Date.now(),
                date: date || new Date().toISOString(),
                text: txt,
                weather: currentUpdateWeather,
                temp: document.getElementById('updateTemp').value,
                photos: [...tmpUp]
            };

            if(editingUpdateId) {
                const idx = e.updates.findIndex(u => u.id === editingUpdateId);
                if(idx >= 0) e.updates[idx] = updateObj;
            } else {
                e.updates.unshift(updateObj);
            }

            saveToStorage();
            resetUpdateForm();
            renderTimeline(e.updates);
        }

        function renderTimeline(updates) {
            const container = document.getElementById('timelineList');
            if(!updates || updates.length === 0) { container.innerHTML = "<div style='font-size:13px;color:#aaa;padding:10px'>Aucun historique</div>"; return; }

            container.innerHTML = updates.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(u => {
                const imgs = (u.photos||[]).map(p=>`<img src="${p}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #eee;margin-top:5px;margin-right:5px" onclick="window.open('${p}')">`).join('');
                const d = new Date(u.date);

                let metaHtml = '';
                if(u.weather) metaHtml += `<span style="margin-right:5px">${getWeatherIcon(u.weather)}</span>`;
                if(u.temp) metaHtml += `<span style="color:#666; font-size:12px">${u.temp}¬∞C</span>`;

                return `
                <div class="t-item ${editingUpdateId === u.id ? 'editing' : ''}">
                    <div class="t-date">
                        <span>${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="t-actions">
                            ${metaHtml}
                            <i class="fas fa-pen" style="cursor:pointer; color:var(--primary); margin-left:10px" onclick="editUpdate(${u.id})"></i>
                            <i class="fas fa-trash" style="cursor:pointer; color:var(--danger)" onclick="delUp(${u.id})"></i>
                        </div>
                    </div>
                    <div class="t-text"><div>${u.text}</div><div>${imgs}</div></div>
                </div>`;
            }).join('');
        }

        function delUp(uid) {
            if(!confirm("Supprimer ?")) return;
            const e = appData.entries.find(x => x.id === curId);
            e.updates = e.updates.filter(u => u.id !== uid);
            if(editingUpdateId === uid) resetUpdateForm();
            saveToStorage(); renderTimeline(e.updates);
        }

        // --- UTILS & SETTINGS ---
        function setNow(id) {
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById(id).value = now.toISOString().slice(0,16);
        }

        function updateDropdowns() {
            const opts = (arr) => arr.map(x => `<option value="${x}">${x}</option>`).join('');
            document.getElementById('entrySite').innerHTML = '<option value="" disabled selected>Choisir...</option>' + opts(appData.settings.sites);
            document.getElementById('entryCategory').innerHTML = opts(appData.settings.categories);
            document.getElementById('filterCategory').innerHTML = '<option value="All">Tout</option>' + opts(appData.settings.categories);
        }

        function renderChips(id, arr, type) {
            document.getElementById(id).innerHTML = arr.map((item,i) => `
                <div style="background:#f2f2f7; padding:5px 10px; border-radius:15px; font-size:13px; display:flex; align-items:center; gap:5px">
                    ${item} <button onclick="rmSet('${type}',${i})" style="border:none;background:none;color:#FF3B30;font-size:14px;padding:0">&times;</button>
                </div>
            `).join('');
        }

        function addSetting(type) {
            const val = document.getElementById(type === 'sites' ? 'newSiteInput' : 'newCatInput').value.trim();
            if(val && !appData.settings[type].includes(val)) {
                appData.settings[type].push(val);
                document.getElementById(type === 'sites' ? 'newSiteInput' : 'newCatInput').value = '';
                saveToStorage(); renderChips(type==='sites'?'siteList':'catList', appData.settings[type], type); updateDropdowns();
            }
        }
        function rmSet(type, i) {
            if(confirm("Supprimer ?")) {
                appData.settings[type].splice(i,1);
                saveToStorage(); renderChips(type==='sites'?'siteList':'catList', appData.settings[type], type); updateDropdowns();
            }
        }

        function savePdfSettings() {
            appData.settings.pdfTitle = document.getElementById('pdfTitleInput').value;
            appData.settings.pdfColor = document.getElementById('pdfColorInput').value;
            saveToStorage();
        }
        async function handleLogoUpload(input) { if(input.files[0]) { appData.settings.logo = await resizeImage(input.files[0], 300); saveToStorage(); renderLogoPreview(); } }
        function removeLogo() { if(confirm("Supprimer logo ?")) { appData.settings.logo = null; saveToStorage(); renderLogoPreview(); } }
        function renderLogoPreview() {
            const lp = document.getElementById('logoPreview');
            lp.innerHTML = appData.settings.logo ? `<img src="${appData.settings.logo}" style="width:100%;height:100%;object-fit:cover">` : ``;
        }

        // --- PDF HELPERS ---
        function getStatusLabel(s) {
            const map = { 'todo': '√Ä faire', 'doing': 'En cours', 'blocked': 'Bloqu√©', 'done': 'Termin√©' };
            return map[s] || s || 'N/A';
        }

        function getWeatherLabel(w) {
            const map = { 'sun': 'Soleil', 'cloud': 'Nuageux', 'rain': 'Pluie', 'snow': 'Neige' };
            return map[w] || '';
        }

        // --- PDF ---
        function exportPDF(singleId = null) {
            const doc = new window.jspdf.jsPDF();
            const title = appData.settings.pdfTitle || "Rapport";

            // USE CUSTOM COLOR
            const colorHex = appData.settings.pdfColor || "#007AFF";
            doc.setFillColor(colorHex);
            doc.rect(0,0,210,35,'F');

            doc.setTextColor(255); doc.setFontSize(18);
            if(appData.settings.logo) { try{ doc.addImage(appData.settings.logo,'JPEG',10,5,25,25); }catch(e){} doc.text(title,40,22); }
            else { doc.text(title,10,22); }

            let y=45;
            let dataToExport = [];

            if(singleId) {
                dataToExport = appData.entries.filter(e => e.id === singleId);
            } else {
                const search = document.getElementById('searchInput').value.toLowerCase();
                const cat = document.getElementById('filterCategory').value;
                const dStart = document.getElementById('dateStart').value;
                const dEnd = document.getElementById('dateEnd').value;

                dataToExport = appData.entries.filter(e => {
                    const matchesText = (e.site.toLowerCase().includes(search) || e.description.toLowerCase().includes(search));
                    const matchesCat = (cat === 'All' || e.category === cat);
                    let matchesDate = true;
                    const entryDate = e.date.substring(0,10);
                    if(dStart && entryDate < dStart) matchesDate = false;
                    if(dEnd && entryDate > dEnd) matchesDate = false;
                    return matchesText && matchesCat && matchesDate;
                }).sort((a,b)=>new Date(b.date)-new Date(a.date));
            }

            if(dataToExport.length === 0) return alert("Aucune donn√©e √† exporter");

            dataToExport.forEach(e => {
                if(y>240){doc.addPage();y=20;}
                doc.setFillColor(242, 242, 247); doc.rect(10,y,190,12,'F');
                doc.setTextColor(0); doc.setFontSize(11); doc.setFont("helvetica","bold");

                doc.text(`${new Date(e.date).toLocaleDateString()} | ${e.site}`, 12, y+6);

                doc.setFontSize(9); doc.setFont("helvetica","normal"); doc.setTextColor(80);

                // --- FIX: USE TEXT HELPERS ---
                let metaText = `Statut: ${getStatusLabel(e.status)}`;
                if(e.weather) metaText += ` | M√©t√©o: ${getWeatherLabel(e.weather)}`;
                if(e.temp) metaText += ` ${e.temp}¬∞C`;

                doc.text(metaText, 12, y+10);

                y+=16;
                doc.setTextColor(0); doc.setFontSize(10);
                const lines = doc.splitTextToSize(e.description, 180);
                doc.text(lines, 12, y); y += (lines.length*5)+5;

                if(e.photos?.length) {
                    let x=12; e.photos.forEach(p=>{
                        if(x>170){x=12;y+=35;} if(y>250){doc.addPage();y=20;}
                        try{doc.addImage(p,'JPEG',x,y,30,30);x+=35;}catch(err){}
                    }); y+=35;
                }

                if(e.updates?.length) {
                    doc.setFont("helvetica","bold"); doc.text("Suivi:", 12, y); y+=5; doc.setFont("helvetica","normal");
                    e.updates.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(u=>{
                       if(y>270){doc.addPage();y=20;}
                       doc.setTextColor(50); doc.setFontSize(9);
                       const d = new Date(u.date);

                       // --- FIX: USE TEXT HELPER FOR UPDATES ---
                       let uMeta = "";
                       if(u.weather) uMeta += ` [${getWeatherLabel(u.weather)}]`;
                       if(u.temp) uMeta += ` ${u.temp}¬∞C`;

                       doc.text(`‚Ä¢ ${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}${uMeta}: ${u.text}`, 15, y); y+=5;

                       if(u.photos && u.photos.length > 0) {
                           let uImgX = 20;
                           if(y + 25 > 280) { doc.addPage(); y=20; }
                           u.photos.forEach(p => {
                               try {
                                   if(uImgX > 180) { uImgX = 20; y+=25; }
                                   doc.addImage(p, 'JPEG', uImgX, y, 20, 20);
                                   uImgX += 25;
                               } catch(e){}
                           });
                           y += 25;
                       }
                    }); y+=5;
                }
                doc.setDrawColor(200); doc.line(10,y,200,y); y+=10;
            });

            const fileName = singleId ? "Fiche_Chantier.pdf" : "Rapport_Complet.pdf";
            doc.save(fileName);
        }
        function exportJSON() {
            const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData));
            a.download="backup.json"; document.body.appendChild(a); a.click(); a.remove();
        }

        initApp();
    </script>
</body>
</html>
