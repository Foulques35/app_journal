<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Journal">
    <meta name="theme-color" content="#f2f2f7">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAnUExURQAAACVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj6yVj65/L52UAAAAMdFJOUwAQHz9Azt9vj+D/y0wtOvwAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACwSURBVHhe7cExAQAAAMKg9U9tCy8gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIB3A8VHAAEdjagAAAAASUVORK5CYII=">

    <title>Journal Chantier</title>

    <style>
        :root {
            --primary: #007AFF;
            --bg-app: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #000000;
            --text-sec: #8E8E93;
            --border: #C6C6C8;
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-app); color: var(--text-main); height: 100dvh; width: 100vw; overflow: hidden; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        * { box-sizing: border-box; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }

        /* --- SVG ICONS --- */
        .icon { width: 16px; height: 16px; fill: currentColor; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 20px; height: 20px; }
        .icon-xl { width: 24px; height: 24px; }

        /* --- VUES --- */
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-app); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1); padding-top: var(--safe-top); padding-bottom: calc(55px + var(--safe-bottom)); z-index: 10; }
        .view.hidden-right { transform: translateX(100%); pointer-events: none; }
        .view.active { transform: translateX(0); }
        .view.hidden-left { transform: translateX(-30%); opacity: 0.8; }

        /* --- MODAL --- */
        .view-modal { position: fixed; z-index: 9999; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1); padding-bottom: var(--safe-bottom); background: var(--bg-app); border-top-left-radius: 15px; border-top-right-radius: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .view-modal.active { transform: translateY(0); }
        .modal-handle { width: 36px; height: 4px; background: #C5C5C7; border-radius: 3px; margin: 6px auto 0 auto; }

        /* --- HEADER --- */
        .nav-bar { height: 44px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 12px; background: rgba(242, 242, 247, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 50; }
        .nav-title { font-size: 16px; font-weight: 600; text-align: center; flex-grow: 1; }
        .nav-btn { color: var(--primary); font-size: 15px; background: none; border: none; cursor: pointer; padding: 8px 4px; display: flex; align-items: center; gap: 4px; }
        .nav-btn.danger { color: var(--danger); }
        .nav-btn.action-primary { background: rgba(0, 122, 255, 0.1); color: var(--primary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0; transition: background 0.2s; }
        .nav-btn.action-primary:active { background: rgba(0, 122, 255, 0.2); }

        /* --- CONTENT --- */
        .content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding: 12px; -webkit-overflow-scrolling: touch; padding-bottom: 90px; }

        /* --- UI ELEMENTS --- */
        .search-container { background: #e3e3e8; border-radius: 10px; padding: 8px 10px; margin-bottom: 10px; }
        .search-bar { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; background: rgba(255,255,255,0.7); padding: 6px 8px; border-radius: 8px; }
        .search-bar input { border: none; background: transparent; font-size: 15px; width: 100%; outline: none; padding: 0; }
        .filter-row-dual { display: flex; gap: 8px; margin-bottom: 8px; }
        .filter-select { flex: 1; border: none; background: white; border-radius: 7px; padding: 6px; font-size: 13px; font-weight: 500; color: var(--primary); text-align: center; appearance: none; -webkit-appearance: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .date-filter-row { display: flex; gap: 8px; align-items: center; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 8px; }
        .date-filter-row input { background: rgba(255,255,255,0.5); border: none; border-radius: 6px; padding: 4px 6px; font-size: 12px; width: 100%; color: var(--text-main); text-align: center; }

        .journal-card { background: var(--bg-card); border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; }
        .journal-card:active { background: #f2f2f2; transform: scale(0.98); transition: 0.1s; }

        .j-header { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; color: var(--text-sec); }
        .j-title { font-size: 16px; font-weight: 600; margin-bottom: 3px; color: var(--text-main); display: flex; align-items: center; gap: 6px; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-todo { background: #8E8E93; }
        .status-doing { background: var(--primary); }
        .status-blocked { background: var(--warning); }
        .status-done { background: var(--success); }

        .j-desc { font-size: 14px; color: #3A3A3C; line-height: 1.35; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .j-footer { margin-top: 8px; display: flex; justify-content: space-between; align-items: flex-end; }
        .j-badges { display: flex; gap: 8px; font-size: 11px; color: var(--text-sec); align-items: center; }
        .badge { background: #E5E5EA; padding: 2px 6px; border-radius: 5px; display: flex; align-items: center; gap: 3px; font-weight: 500; }
        .badge.blue { color: var(--primary); background: rgba(0,122,255,0.1); }
        .btn-pdf-mini { background: rgba(255, 59, 48, 0.1); color: var(--danger); border: 1px solid rgba(255, 59, 48, 0.2); padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 3px; }

        /* --- FORM --- */
        .ios-list { background: var(--bg-card); border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .ios-item { padding: 10px 14px; border-bottom: 1px solid #E5E5EA; display: flex; flex-direction: column; gap: 4px; }
        .ios-item:last-child { border-bottom: none; }
        .ios-label { font-size: 11px; font-weight: 500; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
        .ios-input { font-size: 16px; border: none; width: 100%; outline: none; background: transparent; padding: 3px 0; font-family: inherit; }
        select.ios-input { background-color: transparent; }
        textarea.ios-input { min-height: 80px; resize: none; line-height: 1.4; }

        /* Weather & Status */
        .weather-row { display: flex; gap: 8px; margin-top: 4px; }
        .weather-opt { flex: 1; text-align: center; padding: 5px; border: 1px solid #E5E5EA; border-radius: 7px; cursor: pointer; color: #8E8E93; transition: 0.2s; font-size: 16px; }
        .weather-opt.selected { background: rgba(0,122,255,0.1); border-color: var(--primary); color: var(--primary); }

        .status-pill-container { display: flex; gap: 6px; margin-top: 4px; }
        .status-pill { flex: 1; text-align: center; padding: 6px; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; opacity: 0.4; transition: 0.2s; border: 1px solid transparent; }
        .status-pill.s-todo { background: #E5E5EA; color: #333; }
        .status-pill.s-doing { background: rgba(0,122,255,0.2); color: var(--primary); }
        .status-pill.s-blocked { background: rgba(255,149,0,0.2); color: var(--warning); }
        .status-pill.s-done { background: rgba(52,199,89,0.2); color: var(--success); }
        .status-pill.active { opacity: 1; transform: scale(1.02); box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-color: currentColor; }

        .h-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 6px; }
        .photo-thumb { width: 80px; height: 80px; flex-shrink: 0; border-radius: 8px; overflow: hidden; position: relative; background: #eee; }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .btn-del-photo { position: absolute; top: 3px; right: 3px; width: 20px; height: 20px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .add-photo-btn { width: 80px; height: 80px; flex-shrink: 0; border-radius: 8px; border: 2px dashed #C6C6C8; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); font-size: 11px; font-weight: 600; cursor: pointer; background: rgba(255,255,255,0.5); }

        /* Timeline */
        .timeline { margin-left: 18px; border-left: 2px solid #E5E5EA; padding-left: 18px; }
        .t-item { position: relative; padding-bottom: 20px; transition: background 0.2s; }
        .t-item.editing { background: #fffde7; padding: 8px; border-radius: 8px; margin-left: -8px; border: 1px dashed orange; }
        .t-item::before { content:''; position: absolute; left: -24px; top: 4px; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px #E5E5EA; }
        .t-date { font-size: 11px; color: var(--text-sec); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .t-text { font-size: 15px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #E5E5EA; line-height: 1.35; }
        .t-actions { display: flex; gap: 12px; }

        /* Settings */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: white; border-bottom: 1px solid #E5E5EA; }
        .setting-group { margin-bottom: 20px; border-radius: 12px; overflow: hidden; }
        .setting-header { padding: 0 0 6px 14px; font-size: 12px; color: var(--text-sec); text-transform: uppercase; }

        /* Menu */
        .dropdown-menu { position: absolute; top: 50px; right: 12px; width: 230px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); z-index: 200; display: none; transform-origin: top right; border: 1px solid rgba(0,0,0,0.1); }
        .dropdown-menu.show { display: block; animation: popIn 0.2s; }
        .menu-item { padding: 12px 16px; border-bottom: 1px solid #E5E5EA; display: flex; align-items: center; gap: 10px; font-size: 16px; color: var(--text-main); background: none; border: none; width: 100%; text-align: left; }
        .menu-item:last-child { border-bottom: none; }
        @keyframes popIn { from { opacity:0; transform: scale(0.9); } to { opacity:1; transform: scale(1); } }

        /* Tab Bar (Compact) */
        .tab-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: calc(50px + var(--safe-bottom)); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.15); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 6px; z-index: 100; }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sec); text-decoration: none; font-size: 9px; font-weight: 500; background: none; border: none; cursor: pointer; width: 60px; -webkit-tap-highlight-color: transparent; }
        .tab-item.active { color: var(--primary); }
        .tab-item.big-add { transform: translateY(-18px); }
        .tab-item.big-add div { width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 8px rgba(0,122,255,0.4); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- ICONS SVG -->
    <svg style="display:none">
        <symbol id="icon-search" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-share" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8m-4-6l-4-4-4 4m4-4v13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-list" viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-cog" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/></symbol>
        <symbol id="icon-camera" viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2"/></symbol>
        <symbol id="icon-history" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-back" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-pdf" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" stroke="currentColor" stroke-width="2"/><path d="M14 2v6h6" stroke="currentColor" stroke-width="2"/><path d="M16 13H8" stroke="currentColor" stroke-width="2"/><path d="M16 17H8" stroke="currentColor" stroke-width="2"/><path d="M10 9H8" stroke="currentColor" stroke-width="2"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-save" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" stroke="currentColor" stroke-width="2"/><path d="M17 21v-8H7v8" stroke="currentColor" stroke-width="2"/><path d="M7 3v5h8" stroke="currentColor" stroke-width="2"/></symbol>
        <symbol id="icon-upload" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M17 8l-5-5-5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
        <symbol id="icon-pen" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" stroke="currentColor" stroke-width="2"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2"/></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-close" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
        <symbol id="icon-up" viewBox="0 0 24 24"><path d="M5 10l7-7m0 0l7 7m-7-7v18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>
    </svg>

    <!-- === VIEW 1: LISTE === -->
    <div id="viewList" class="view active">
        <div class="nav-bar">
            <div style="width:32px"></div>
            <div class="nav-title">Journal</div>
            <button class="nav-btn action-primary" onclick="toggleExportMenu()">
                <svg class="icon-lg" style="fill:none;stroke:currentColor;stroke-width:2"><use href="#icon-share"/></svg>
            </button>
        </div>
        <div id="exportMenu" class="dropdown-menu">
            <button class="menu-item" onclick="exportPDF(null);toggleExportMenu()">
                <svg class="icon" style="color:#FF3B30;fill:none;margin-right:8px"><use href="#icon-pdf"/></svg> Rapport (Visible)
            </button>
            <button class="menu-item" onclick="exportJSON();toggleExportMenu()">
                <svg class="icon" style="color:#34C759;fill:none;margin-right:8px"><use href="#icon-save"/></svg> Sauvegarde JSON
            </button>
            <label class="menu-item" style="cursor:pointer; color:var(--primary)">
                <svg class="icon" style="fill:none;margin-right:8px"><use href="#icon-upload"/></svg> Restaurer Sauvegarde
                <input type="file" accept=".json" style="display:none" onchange="importJSON(this)">
            </label>
        </div>
        <div class="content">
            <div class="search-container">
                <div class="search-bar">
                    <svg class="icon" style="color:#8E8E93;fill:none"><use href="#icon-search"/></svg>
                    <input type="text" id="searchInput" placeholder="Rechercher..." onkeyup="renderList()">
                </div>
                <div class="filter-row-dual">
                    <select id="filterCategory" onchange="renderList()" class="filter-select"><option value="All">Toutes Rubriques</option></select>
                    <select id="filterStatus" onchange="renderList()" class="filter-select">
                        <option value="All">Tous Statuts</option>
                        <option value="todo">√Ä faire</option>
                        <option value="doing">En cours</option>
                        <option value="blocked">Bloqu√©</option>
                        <option value="done">Termin√©</option>
                    </select>
                </div>
                <div class="date-filter-row">
                    <input type="date" id="dateStart" onchange="renderList()" placeholder="Du...">
                    <span style="color:#8E8E93; font-size:12px">au</span>
                    <input type="date" id="dateEnd" onchange="renderList()" placeholder="Au...">
                </div>
            </div>
            <div style="font-size:12px; color:#8E8E93; margin:0 0 8px 5px;"><span id="countDisplay">0</span> fiches</div>
            <div id="entryList"></div>
            <div style="height: 60px;"></div>
        </div>
    </div>

    <!-- === VIEW 2: FORMULAIRE === -->
    <div id="viewForm" class="view hidden-right" style="z-index: 15;">
        <div class="nav-bar">
            <button class="nav-btn" onclick="goBack()">
                <svg class="icon" style="fill:none;margin-right:2px"><use href="#icon-back"/></svg> Retour
            </button>
            <div class="nav-title" id="formTitle">Fiche</div>
            <button class="nav-btn" onclick="saveEntry()" style="font-weight:700; font-size:16px">OK</button>
        </div>
        <div class="content">
            <input type="hidden" id="entryId">
            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">Statut</span>
                    <div class="status-pill-container" id="statusSelector">
                        <div class="status-pill s-todo" onclick="setStatus('todo')">√Ä faire</div>
                        <div class="status-pill s-doing" onclick="setStatus('doing')">En cours</div>
                        <div class="status-pill s-blocked" onclick="setStatus('blocked')">Bloqu√©</div>
                        <div class="status-pill s-done" onclick="setStatus('done')">Termin√©</div>
                    </div>
                </div>
                <div class="ios-item">
                    <span class="ios-label">Date et Heure</span>
                    <input type="datetime-local" id="entryDate" class="ios-input">
                </div>
                <div class="ios-item">
                    <span class="ios-label">M√©t√©o & Temp√©rature</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="weather-row" id="weatherSelector" style="flex:1">
                            <div class="weather-opt" onclick="setWeather('sun')">‚òÄÔ∏è</div>
                            <div class="weather-opt" onclick="setWeather('cloud')">‚òÅÔ∏è</div>
                            <div class="weather-opt" onclick="setWeather('rain')">üåßÔ∏è</div>
                            <div class="weather-opt" onclick="setWeather('snow')">‚ùÑÔ∏è</div>
                        </div>
                        <input type="number" id="entryTemp" class="ios-input" placeholder="¬∞C" style="width:50px; text-align:center; border:1px solid #E5E5EA; border-radius:8px; padding:6px;">
                    </div>
                </div>
            </div>

            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">Lieu / Site</span>
                    <select id="entrySite" class="ios-input"></select>
                </div>
                <div class="ios-item">
                    <span class="ios-label">Rubrique</span>
                    <select id="entryCategory" class="ios-input"></select>
                </div>
                <div class="ios-item">
                    <span class="ios-label">Avancement: <span id="progDisplay" style="color:var(--primary); font-weight:600">0%</span></span>
                    <input type="range" id="entryProgress" min="0" max="100" step="10" value="0" style="width:100%; margin-top:8px" oninput="document.getElementById('progDisplay').innerText=this.value+'%'">
                </div>
            </div>

            <div class="ios-list">
                <div class="ios-item">
                    <span class="ios-label">Description</span>
                    <textarea id="entryDesc" class="ios-input" placeholder="Notes, observations..."></textarea>
                </div>
                <div class="ios-item">
                    <span class="ios-label" style="margin-bottom:8px">Photos</span>
                    <div class="h-scroll">
                        <label class="add-photo-btn">
                            <svg class="icon-lg" style="fill:none;stroke:currentColor;stroke-width:1.5"><use href="#icon-camera"/></svg>
                            <span style="margin-top:2px">Ajouter</span>
                            <input type="file" multiple accept="image/*" style="display:none" onchange="handleMainPhotos(this)">
                        </label>
                        <div id="mainPhotoGallery" style="display:flex; gap:10px"></div>
                    </div>
                </div>
            </div>

            <div id="timelineSection" class="hidden">
                <h4 style="margin:20px 0 10px 10px; color:var(--text-sec); text-transform:uppercase; font-size:12px;">Historique & Suivi</h4>
                <div class="ios-list" style="margin-bottom:15px; border:1px solid var(--primary); background:#f0f9ff" id="updateFormBox">
                    <div class="ios-item">
                         <span class="ios-label" style="color:var(--primary)" id="updateFormLabel">Ajouter un suivi</span>
                         <div style="display:flex; gap:10px; margin-bottom:5px">
                            <input type="datetime-local" id="updateDate" class="ios-input" style="color:var(--text-main); font-size:13px; width:auto">
                            <div class="weather-row" id="updateWeatherSelector" style="flex:1; margin-top:0">
                                <div class="weather-opt" style="padding:2px; font-size:14px" onclick="setUpdateWeather('sun')">‚òÄÔ∏è</div>
                                <div class="weather-opt" style="padding:2px; font-size:14px" onclick="setUpdateWeather('cloud')">‚òÅÔ∏è</div>
                                <div class="weather-opt" style="padding:2px; font-size:14px" onclick="setUpdateWeather('rain')">üåßÔ∏è</div>
                                <div class="weather-opt" style="padding:2px; font-size:14px" onclick="setUpdateWeather('snow')">‚ùÑÔ∏è</div>
                            </div>
                            <input type="number" id="updateTemp" class="ios-input" placeholder="¬∞C" style="width:36px; text-align:center; border-bottom:1px solid #ddd; font-size:13px">
                         </div>
                         <div style="display:flex; align-items:center; gap:10px">
                             <input type="text" id="updateText" class="ios-input" placeholder="Note de suivi..." style="flex-grow:1; border-bottom:1px solid #eee">
                             <label style="color:var(--primary); cursor:pointer">
                                 <svg class="icon-lg" style="fill:none"><use href="#icon-camera"/></svg>
                                 <input type="file" multiple accept="image/*" style="display:none" onchange="handleUpdatePhotos(this)">
                             </label>
                             <button id="btnSaveUpdate" onclick="saveUpdate()" style="background:var(--success); color:white; border:none; border-radius:15px; width:30px; height:30px; display:flex; align-items:center; justify-content:center">
                                 <svg class="icon" style="fill:none; stroke:currentColor; stroke-width:3"><use href="#icon-up"/></svg>
                             </button>
                         </div>
                    </div>
                    <div id="updatePhotoPreview" class="h-scroll" style="padding:0 15px 10px 15px;"></div>
                </div>
                <div class="timeline" id="timelineList"></div>
            </div>

            <button id="deleteBtn" class="nav-btn danger" style="width:100%; margin-top:20px; padding:12px; background:white; border-radius:10px; font-weight:600; justify-content: center;" onclick="deleteEntry()">
                Supprimer cette fiche
            </button>
            <div style="height: 100px;"></div>
        </div>
    </div>

    <!-- === VIEW 3: SETTINGS === -->
    <div id="viewSettings" class="view view-modal">
        <div class="modal-handle"></div>
        <div class="nav-bar" style="background:transparent; border:none;">
            <div class="nav-title">R√©glages</div>
            <button class="nav-btn" onclick="closeSettings()" style="position:absolute; right:15px; font-weight:700; background:#E5E5EA; border-radius:50%; width:28px; height:28px; padding:0; display:flex; align-items:center; justify-content:center; color:#8E8E93">
                <svg class="icon" style="fill:none; stroke:currentColor; stroke-width:2"><use href="#icon-close"/></svg>
            </button>
        </div>
        <div class="content">
            <div class="setting-header">PDF</div>
            <div class="setting-group">
                <div class="setting-row">
                    <span>Titre</span>
                    <input type="text" id="pdfTitleInput" onchange="savePdfSettings()" style="text-align:right; border:none; color:var(--primary); outline:none; font-size:16px" placeholder="Rapport...">
                </div>
                <div class="setting-row">
                    <span>Entreprise</span>
                    <input type="text" id="companyNameInput" onchange="savePdfSettings()" style="text-align:right; border:none; color:var(--primary); outline:none; font-size:16px" placeholder="Votre Soci√©t√©">
                </div>
                <div class="setting-row">
                    <span>Couleur Th√®me</span>
                    <input type="color" id="pdfColorInput" onchange="savePdfSettings()" style="border:none; background:none; height:28px; width:40px; padding:0; -webkit-appearance:none;">
                </div>
                <div class="setting-row">
                    <span>Logo</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div id="logoPreview" style="width:36px; height:36px; background:#eee; border-radius:6px; overflow:hidden"></div>
                        <label style="color:var(--primary); cursor:pointer">Choisir<input type="file" accept="image/*" style="display:none" onchange="handleLogoUpload(this)"></label>
                        <button onclick="removeLogo()" style="border:none; background:none; color:var(--danger); font-size:16px">
                            <svg class="icon" style="fill:none"><use href="#icon-trash"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="setting-header">Configuration</div>
            <div class="setting-group">
                <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:10px">
                    <div style="display:flex; justify-content:space-between"><strong>Lieux / Sites</strong></div>
                    <div id="siteList" style="display:flex; flex-wrap:wrap; gap:8px"></div>
                    <div style="display:flex; gap:10px; margin-top:5px">
                        <input type="text" id="newSiteInput" placeholder="Nouveau..." style="flex:1; border:1px solid #ddd; border-radius:8px; padding:6px; font-size:15px;">
                        <button onclick="addSetting('sites')" style="background:var(--primary); color:white; border:none; border-radius:8px; padding:0 12px; font-weight:600">OK</button>
                    </div>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:10px">
                    <div style="display:flex; justify-content:space-between"><strong>Rubriques</strong></div>
                    <div id="catList" style="display:flex; flex-wrap:wrap; gap:8px"></div>
                    <div style="display:flex; gap:10px; margin-top:5px">
                        <input type="text" id="newCatInput" placeholder="Nouvelle..." style="flex:1; border:1px solid #ddd; border-radius:8px; padding:6px; font-size:15px;">
                        <button onclick="addSetting('categories')" style="background:var(--primary); color:white; border:none; border-radius:8px; padding:0 12px; font-weight:600">OK</button>
                    </div>
                </div>
            </div>
            <div style="text-align:center; font-size:11px; color:var(--text-sec); margin-top:20px; line-height:1.5;">
                Cr√©√© par Maxime Bousquet - Licence MIT<br>Version 25.0
            </div>
            <div style="height:100px"></div>
        </div>
    </div>

    <!-- === TAB BAR === -->
    <div class="tab-bar">
        <button class="tab-item active" onclick="goHome()">
            <svg class="icon-lg" style="fill:none; stroke:currentColor; stroke-width:2"><use href="#icon-list"/></svg>
            <span style="margin-top:2px">Journal</span>
        </button>
        <button class="tab-item big-add" onclick="createNew()">
            <div><svg class="icon-xl" style="fill:none; stroke:currentColor; stroke-width:2"><use href="#icon-plus"/></svg></div>
        </button>
        <button class="tab-item" onclick="openSettings()">
            <svg class="icon-lg" style="fill:none; stroke:currentColor; stroke-width:2"><use href="#icon-cog"/></svg>
            <span style="margin-top:2px">R√©glages</span>
        </button>
    </div>

    <script>
        // --- NAVIGATION ---
        function goHome() {
            document.getElementById('viewList').classList.remove('hidden-left');
            document.getElementById('viewList').classList.add('active');
            document.getElementById('viewForm').classList.remove('active');
            document.getElementById('viewForm').classList.add('hidden-right');
            closeSettings();
        }

        function goBack() { goHome(); }

        function openForm() {
            document.getElementById('viewList').classList.remove('active');
            document.getElementById('viewList').classList.add('hidden-left');
            document.getElementById('viewForm').classList.remove('hidden-right');
            document.getElementById('viewForm').classList.add('active');
        }

        function openSettings() { document.getElementById('viewSettings').classList.add('active'); }
        function closeSettings() { document.getElementById('viewSettings').classList.remove('active'); }

        function toggleExportMenu() { document.getElementById('exportMenu').classList.toggle('show'); }
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('exportMenu');
            const btn = document.querySelector('.nav-btn.action-primary');
            if (!menu.contains(event.target) && !btn.contains(event.target) && menu.classList.contains('show')) {
                menu.classList.remove('show');
            }
        });

        // --- DATA ---
        const defaultSettings = {
            sites: ["B√¢timent A", "B√¢timent B", "Ext√©rieur"],
            categories: ["G√©n√©ral", "√âlectricit√©", "Plomberie", "Ma√ßonnerie"],
            pdfTitle: "Rapport de Chantier",
            companyName: "",
            pdfColor: "#007AFF",
            logo: null
        };
        let appData = { settings: {...defaultSettings}, entries: [] };

        let currentStatus = 'todo';
        let currentWeather = null;
        let currentUpdateWeather = null;
        let editingUpdateId = null;

        function initApp() {
            const raw = localStorage.getItem('journal_v14');
            if (raw) {
                appData = JSON.parse(raw);
                appData.settings = {...defaultSettings, ...appData.settings};
            }
            updateDropdowns(); renderList();

            document.getElementById('pdfTitleInput').value = appData.settings.pdfTitle;
            document.getElementById('companyNameInput').value = appData.settings.companyName || "";
            document.getElementById('pdfColorInput').value = appData.settings.pdfColor || "#007AFF";
            renderLogoPreview();
            renderChips('siteList', appData.settings.sites, 'sites');
            renderChips('catList', appData.settings.categories, 'categories');
        }

        function saveToStorage() { localStorage.setItem('journal_v14', JSON.stringify(appData)); }

        // --- IMPORT JSON ---
        function importJSON(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data && data.entries) {
                        if(confirm("Attention: Cela va remplacer les donn√©es actuelles. Continuer ?")) {
                            appData = data;
                            if(!appData.settings) appData.settings = {...defaultSettings};
                            saveToStorage();
                            initApp();
                            alert("Restauration r√©ussie !");
                        }
                    } else { alert("Fichier invalide"); }
                } catch(err) { alert("Erreur de lecture du fichier"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- UI HELPERS ---
        function setStatus(s) {
            currentStatus = s;
            document.querySelectorAll('#statusSelector .status-pill').forEach(el => el.classList.remove('active'));
            document.querySelector(`#statusSelector .status-pill.s-${s}`).classList.add('active');
        }

        function setWeather(w) {
            currentWeather = w;
            document.querySelectorAll('#weatherSelector .weather-opt').forEach(el => el.classList.remove('selected'));
            if(w) {
                const types = ['sun', 'cloud', 'rain', 'snow'];
                const idx = types.indexOf(w);
                if(idx >= 0) document.querySelectorAll('#weatherSelector .weather-opt')[idx].classList.add('selected');
            }
        }

        function setUpdateWeather(w) {
            currentUpdateWeather = w;
            document.querySelectorAll('#updateWeatherSelector .weather-opt').forEach(el => el.classList.remove('selected'));
            if(w) {
                const types = ['sun', 'cloud', 'rain', 'snow'];
                const idx = types.indexOf(w);
                if(idx >= 0) document.querySelectorAll('#updateWeatherSelector .weather-opt')[idx].classList.add('selected');
            }
        }

        function getWeatherIcon(w) {
            if(w=='sun') return '‚òÄÔ∏è'; if(w=='cloud') return '‚òÅÔ∏è'; if(w=='rain') return 'üåßÔ∏è'; if(w=='snow') return '‚ùÑÔ∏è';
            return '';
        }

        // --- LIST & FILTER ---
        function renderList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('filterCategory').value;
            const status = document.getElementById('filterStatus').value;
            const dStart = document.getElementById('dateStart').value;
            const dEnd = document.getElementById('dateEnd').value;

            const res = appData.entries.filter(e => {
                const matchesText = (e.site.toLowerCase().includes(search) || e.description.toLowerCase().includes(search));
                const matchesCat = (cat === 'All' || e.category === cat);
                const matchesStatus = (status === 'All' || (e.status||'todo') === status);

                let matchesDate = true;
                const entryDate = e.date.substring(0,10);
                if(dStart && entryDate < dStart) matchesDate = false;
                if(dEnd && entryDate > dEnd) matchesDate = false;

                return matchesText && matchesCat && matchesStatus && matchesDate;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            document.getElementById('countDisplay').innerText = res.length;

            document.getElementById('entryList').innerHTML = res.map(e => {
                const pCount = (e.photos?.length||0);
                const uCount = (e.updates?.length||0);
                const dateObj = new Date(e.date);
                const statusColor = e.status === 'done' ? 'status-done' : (e.status === 'blocked' ? 'status-blocked' : (e.status === 'doing' ? 'status-doing' : 'status-todo'));

                return `
                <div class="journal-card" onclick="loadEntry(${e.id})">
                    <div class="j-header">
                        <span>${dateObj.getDate()} ${dateObj.toLocaleString('default', { month: 'short' })} ‚Ä¢ ${dateObj.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                        <div style="display:flex; align-items:center; gap:6px">
                            ${e.weather ? `<span>${getWeatherIcon(e.weather)}</span>` : ''}
                            <span style="color:var(--primary);font-weight:600">${e.progress}%</span>
                        </div>
                    </div>
                    <div class="j-title">
                        <span class="status-dot ${statusColor}"></span>
                        ${e.site}
                        <span style="font-weight:400; color:var(--text-sec); font-size:14px">(${e.category})</span>
                    </div>
                    <div class="j-desc">${e.description}</div>
                    <div class="j-footer">
                        <div class="j-badges">
                            ${pCount ? `<div class="badge blue"><svg class="icon" style="fill:none;stroke:currentColor"><use href="#icon-camera"/></svg> ${pCount}</div>` : ''}
                            ${uCount ? `<div class="badge"><svg class="icon" style="fill:none;stroke:currentColor"><use href="#icon-history"/></svg> ${uCount}</div>` : ''}
                        </div>
                        <button class="btn-pdf-mini" onclick="event.stopPropagation(); exportPDF(${e.id})">
                            <svg class="icon" style="fill:none;color:inherit;margin-right:2px"><use href="#icon-pdf"/></svg> PDF
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- CRUD MAIN ---
        let curId = null;
        let tmpMain=[], tmpUp=[];

        function createNew() {
            curId = null; tmpMain=[]; resetUpdateForm();
            document.getElementById('formTitle').innerText = "Nouvelle Fiche";
            document.getElementById('entrySite').value = '';
            document.getElementById('entryDesc').value = '';
            document.getElementById('entryProgress').value = 0; document.getElementById('progDisplay').innerText="0%";
            document.getElementById('entryTemp').value = '';
            setStatus('todo'); setWeather(null);

            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('timelineSection').classList.add('hidden');

            setNow('entryDate');
            renderGal('mainPhotoGallery', tmpMain, 'tmpMain');
            openForm();
        }

        function loadEntry(id) {
            curId = id;
            const e = appData.entries.find(x => x.id === id);

            document.getElementById('formTitle').innerText = "D√©tails";
            document.getElementById('entryDate').value = e.date;
            document.getElementById('entryCategory').value = e.category;
            document.getElementById('entryProgress').value = e.progress;
            document.getElementById('progDisplay').innerText = e.progress+'%';
            document.getElementById('entryDesc').value = e.description;
            document.getElementById('entryTemp').value = e.temp || '';

            setStatus(e.status || 'todo');
            setWeather(e.weather || null);

            const sSel = document.getElementById('entrySite');
            if(![...sSel.options].some(o => o.value === e.site)) {
                 const opt = document.createElement('option'); opt.value = e.site; opt.text = e.site + " (Archiv√©)"; sSel.add(opt);
            }
            sSel.value = e.site;

            tmpMain = [...e.photos||[]]; renderGal('mainPhotoGallery', tmpMain, 'tmpMain');
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('timelineSection').classList.remove('hidden');
            renderTimeline(e.updates||[]);

            resetUpdateForm();
            openForm();
        }

        function saveEntry() {
            const site = document.getElementById('entrySite').value;
            if(!site) return alert("Choisissez un lieu");

            const entry = {
                id: curId || Date.now(),
                date: document.getElementById('entryDate').value,
                site: site,
                category: document.getElementById('entryCategory').value,
                progress: document.getElementById('entryProgress').value,
                description: document.getElementById('entryDesc').value,
                status: currentStatus,
                weather: currentWeather,
                temp: document.getElementById('entryTemp').value,
                photos: [...tmpMain],
                updates: curId ? appData.entries.find(e=>e.id===curId).updates : []
            };

            if(curId) { const i = appData.entries.findIndex(e=>e.id===curId); appData.entries[i] = entry; }
            else { appData.entries.unshift(entry); curId = entry.id; }

            saveToStorage(); goHome(); renderList();
        }

        function deleteEntry() {
            if(confirm("Supprimer ?")) {
                appData.entries = appData.entries.filter(e => e.id !== curId);
                saveToStorage(); goHome(); renderList();
            }
        }

        // --- MEDIA ---
        function resizeImage(file, max=800) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        let w=img.width, h=img.height;
                        if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}
                        c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
                        r(c.toDataURL('image/jpeg', 0.6));
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            });
        }

        async function handleMainPhotos(inp) { if(inp.files) for(let f of inp.files) tmpMain.push(await resizeImage(f)); renderGal('mainPhotoGallery', tmpMain, 'tmpMain'); inp.value=''; }
        async function handleUpdatePhotos(inp) { if(inp.files) for(let f of inp.files) tmpUp.push(await resizeImage(f)); renderGal('updatePhotoPreview', tmpUp, 'tmpUp'); inp.value=''; }

        function renderGal(id, arr, varName) {
            document.getElementById(id).innerHTML = arr.map((p,i) =>
                `<div class="photo-thumb"><img src="${p}" onclick="window.open('${p}')"><button class="btn-del-photo" onclick="${varName}.splice(${i},1);renderGal('${id}',${varName},'${varName}')">√ó</button></div>`
            ).join('');
        }

        // --- TIMELINE CRUD ---
        function resetUpdateForm() {
            tmpUp = [];
            editingUpdateId = null;
            document.getElementById('updateText').value = '';
            document.getElementById('updateTemp').value = '';
            setUpdateWeather(null);
            setNow('updateDate');
            renderGal('updatePhotoPreview', tmpUp, 'tmpUp');

            document.getElementById('updateFormLabel').innerText = "Ajouter un suivi";
            document.getElementById('updateFormBox').style.background = "#f0f9ff";
            document.getElementById('btnSaveUpdate').innerHTML = '<svg class="icon" style="fill:none;stroke:currentColor;stroke-width:3"><use href="#icon-up"/></svg>';
        }

        function editUpdate(uid) {
            const e = appData.entries.find(x => x.id === curId);
            const u = e.updates.find(up => up.id === uid);
            if(!u) return;

            editingUpdateId = uid;
            document.getElementById('updateText').value = u.text;
            document.getElementById('updateDate').value = u.date;
            document.getElementById('updateTemp').value = u.temp || '';
            setUpdateWeather(u.weather || null);
            tmpUp = [...(u.photos || [])];
            renderGal('updatePhotoPreview', tmpUp, 'tmpUp');

            document.getElementById('updateFormLabel').innerText = "Modifier le suivi";
            document.getElementById('updateFormBox').style.background = "#fffde7";
            document.getElementById('btnSaveUpdate').innerHTML = '<svg class="icon" style="fill:none;stroke:currentColor;stroke-width:3"><use href="#icon-check"/></svg>';
            document.getElementById('updateText').focus();
        }

        function saveUpdate() {
            if(!curId) return;
            const txt = document.getElementById('updateText').value;
            const date = document.getElementById('updateDate').value;
            if(!txt && tmpUp.length===0 && !editingUpdateId) return;

            const e = appData.entries.find(x => x.id === curId);
            if(!e.updates) e.updates = [];

            const updateObj = {
                id: editingUpdateId || Date.now(),
                date: date || new Date().toISOString(),
                text: txt, weather: currentUpdateWeather, temp: document.getElementById('updateTemp').value,
                photos: [...tmpUp]
            };

            if(editingUpdateId) {
                const idx = e.updates.findIndex(u => u.id === editingUpdateId);
                if(idx >= 0) e.updates[idx] = updateObj;
            } else { e.updates.unshift(updateObj); }

            saveToStorage(); resetUpdateForm(); renderTimeline(e.updates);
        }

        function renderTimeline(updates) {
            const container = document.getElementById('timelineList');
            if(!updates || updates.length === 0) { container.innerHTML = "<div style='font-size:13px;color:#aaa;padding:10px'>Aucun historique</div>"; return; }

            container.innerHTML = updates.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(u => {
                const imgs = (u.photos||[]).map(p=>`<img src="${p}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #eee;margin-top:5px;margin-right:5px" onclick="window.open('${p}')">`).join('');
                const d = new Date(u.date);
                let metaHtml = '';
                if(u.weather) metaHtml += `<span style="margin-right:5px">${getWeatherIcon(u.weather)}</span>`;
                if(u.temp) metaHtml += `<span style="color:#666; font-size:12px">${u.temp}¬∞C</span>`;

                return `
                <div class="t-item ${editingUpdateId === u.id ? 'editing' : ''}">
                    <div class="t-date">
                        <span>${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                        <div class="t-actions">
                            ${metaHtml}
                            <span style="cursor:pointer; color:var(--primary); margin-left:10px" onclick="editUpdate(${u.id})"><svg class="icon" style="fill:none;stroke:currentColor;stroke-width:2"><use href="#icon-pen"/></svg></span>
                            <span style="cursor:pointer; color:var(--danger)" onclick="delUp(${u.id})"><svg class="icon" style="fill:none;stroke:currentColor;stroke-width:2"><use href="#icon-trash"/></svg></span>
                        </div>
                    </div>
                    <div class="t-text"><div>${u.text}</div><div>${imgs}</div></div>
                </div>`;
            }).join('');
        }

        function delUp(uid) {
            if(!confirm("Supprimer ?")) return;
            const e = appData.entries.find(x => x.id === curId);
            e.updates = e.updates.filter(u => u.id !== uid);
            if(editingUpdateId === uid) resetUpdateForm();
            saveToStorage(); renderTimeline(e.updates);
        }

        // --- UTILS & SETTINGS ---
        function setNow(id) {
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById(id).value = now.toISOString().slice(0,16);
        }

        function updateDropdowns() {
            const opts = (arr) => arr.map(x => `<option value="${x}">${x}</option>`).join('');
            document.getElementById('entrySite').innerHTML = '<option value="" disabled selected>Choisir...</option>' + opts(appData.settings.sites);
            document.getElementById('entryCategory').innerHTML = opts(appData.settings.categories);
            document.getElementById('filterCategory').innerHTML = '<option value="All">Toutes Rubriques</option>' + opts(appData.settings.categories);
        }

        function renderChips(id, arr, type) {
            document.getElementById(id).innerHTML = arr.map((item,i) => `
                <div style="background:#f2f2f7; padding:5px 10px; border-radius:15px; font-size:13px; display:flex; align-items:center; gap:5px">
                    ${item} <button onclick="rmSet('${type}',${i})" style="border:none;background:none;color:#FF3B30;font-size:14px;padding:0">√ó</button>
                </div>
            `).join('');
        }

        function addSetting(type) {
            const val = document.getElementById(type === 'sites' ? 'newSiteInput' : 'newCatInput').value.trim();
            if(val && !appData.settings[type].includes(val)) {
                appData.settings[type].push(val);
                document.getElementById(type === 'sites' ? 'newSiteInput' : 'newCatInput').value = '';
                saveToStorage(); renderChips(type==='sites'?'siteList':'catList', appData.settings[type], type); updateDropdowns();
            }
        }
        function rmSet(type, i) {
            if(confirm("Supprimer ?")) {
                appData.settings[type].splice(i,1);
                saveToStorage(); renderChips(type==='sites'?'siteList':'catList', appData.settings[type], type); updateDropdowns();
            }
        }

        function savePdfSettings() {
            appData.settings.pdfTitle = document.getElementById('pdfTitleInput').value;
            appData.settings.pdfColor = document.getElementById('pdfColorInput').value;
            appData.settings.companyName = document.getElementById('companyNameInput').value;
            saveToStorage();
        }
        async function handleLogoUpload(input) { if(input.files[0]) { appData.settings.logo = await resizeImage(input.files[0], 300); saveToStorage(); renderLogoPreview(); } }
        function removeLogo() { if(confirm("Supprimer logo ?")) { appData.settings.logo = null; saveToStorage(); renderLogoPreview(); } }
        function renderLogoPreview() {
            const lp = document.getElementById('logoPreview');
            lp.innerHTML = appData.settings.logo ? `<img src="${appData.settings.logo}" style="width:100%;height:100%;object-fit:cover">` : ``;
        }

        // --- PDF HELPERS ---
        function getStatusLabel(s) { return { 'todo': '√Ä faire', 'doing': 'En cours', 'blocked': 'Bloqu√©', 'done': 'Termin√©' }[s] || s || 'N/A'; }
        function getWeatherLabel(w) { return { 'sun': 'Soleil', 'cloud': 'Nuageux', 'rain': 'Pluie', 'snow': 'Neige' }[w] || ''; }

        // --- PDF DYNAMIC LOADER ---
        async function loadPdfLib() {
            if (window.jspdf) return true;
            return new Promise(resolve => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => resolve(true);
                script.onerror = () => resolve(false);
                document.body.appendChild(script);
            });
        }

        async function exportPDF(singleId = null) {
            const loaded = await loadPdfLib();
            if (!loaded) {
                alert("Connexion Internet requise pour activer la cr√©ation de PDF (une seule fois).");
                return;
            }

            const doc = new window.jspdf.jsPDF();
            const title = appData.settings.pdfTitle || "Rapport";
            const colorHex = appData.settings.pdfColor || "#007AFF";
            doc.setFillColor(colorHex); doc.rect(0,0,210,35,'F');
            doc.setTextColor(255); doc.setFontSize(18);

            if(appData.settings.logo) {
                try{ doc.addImage(appData.settings.logo,'JPEG',10,5,25,25); }catch(e){}
                doc.text(title,40,22);
            } else {
                doc.text(title,10,22);
            }

            let y=45;
            let dataToExport = [];

            if(singleId) {
                dataToExport = appData.entries.filter(e => e.id === singleId);
            } else {
                const search = document.getElementById('searchInput').value.toLowerCase();
                const cat = document.getElementById('filterCategory').value;
                const status = document.getElementById('filterStatus').value;
                const dStart = document.getElementById('dateStart').value;
                const dEnd = document.getElementById('dateEnd').value;

                dataToExport = appData.entries.filter(e => {
                    const matchesText = (e.site.toLowerCase().includes(search) || e.description.toLowerCase().includes(search));
                    const matchesCat = (cat === 'All' || e.category === cat);
                    const matchesStatus = (status === 'All' || (e.status||'todo') === status);
                    let matchesDate = true;
                    const entryDate = e.date.substring(0,10);
                    if(dStart && entryDate < dStart) matchesDate = false;
                    if(dEnd && entryDate > dEnd) matchesDate = false;
                    return matchesText && matchesCat && matchesStatus && matchesDate;
                }).sort((a,b)=>new Date(b.date)-new Date(a.date));
            }

            if(dataToExport.length === 0) return alert("Aucune donn√©e √† exporter");

            dataToExport.forEach(e => {
                if(y>240){doc.addPage();y=20;}
                doc.setFillColor(242, 242, 247); doc.rect(10,y,190,12,'F');
                doc.setTextColor(0); doc.setFontSize(11); doc.setFont("helvetica","bold");
                doc.text(`${new Date(e.date).toLocaleDateString()} | ${e.site}`, 12, y+6);
                doc.setFontSize(9); doc.setFont("helvetica","normal"); doc.setTextColor(80);

                let metaText = `Statut: ${getStatusLabel(e.status)}`;
                if(e.weather) metaText += ` | M√©t√©o: ${getWeatherLabel(e.weather)}`;
                if(e.temp) metaText += ` ${e.temp}¬∞C`;
                doc.text(metaText, 12, y+10);

                y+=16; doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "bold");
                const lines = doc.splitTextToSize(e.description, 180);
                doc.text(lines, 12, y); y += (lines.length*5)+5;

                if(e.photos?.length) {
                    let x=12; e.photos.forEach(p=>{
                        if(x>170){x=12;y+=35;} if(y>250){doc.addPage();y=20;}
                        try{doc.addImage(p,'JPEG',x,y,30,30);x+=35;}catch(err){}
                    }); y+=35;
                }

                if(e.updates?.length) {
                    doc.setFont("helvetica","bold"); doc.text("Suivi:", 12, y); y+=5; doc.setFont("helvetica","normal");
                    e.updates.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(u=>{
                       if(y>270){doc.addPage();y=20;}
                       doc.setTextColor(50); doc.setFontSize(9);
                       const d = new Date(u.date);
                       let uMeta = "";
                       if(u.weather) uMeta += ` [${getWeatherLabel(u.weather)}]`;
                       if(u.temp) uMeta += ` ${u.temp}¬∞C`;
                       doc.text(`‚Ä¢ ${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}${uMeta}: ${u.text}`, 15, y); y+=5;
                       if(u.photos && u.photos.length > 0) {
                           let uImgX = 20;
                           if(y + 25 > 280) { doc.addPage(); y=20; }
                           u.photos.forEach(p => {
                               try { if(uImgX > 180) { uImgX = 20; y+=25; } doc.addImage(p, 'JPEG', uImgX, y, 20, 20); uImgX += 25; } catch(e){}
                           }); y += 25;
                       }
                    }); y+=5;
                }
                doc.setDrawColor(200); doc.line(10,y,200,y); y+=10;
            });

            // Add Footer to all pages
            const pageCount = doc.internal.getNumberOfPages();
            doc.setFont("helvetica", "italic");
            doc.setFontSize(8);
            doc.setTextColor(150);

            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                const pageSize = doc.internal.pageSize;
                const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                const pageWidth = pageSize.width ? pageSize.width : pageSize.getWidth();

                // Company Name (Left)
                if (appData.settings.companyName) {
                    doc.text(appData.settings.companyName, 10, pageHeight - 10);
                }

                // Credits (Right)
                const creditText = "Cr√©√© par Maxime Bousquet - Licence MIT";
                const textWidth = doc.getTextWidth(creditText);
                doc.text(creditText, pageWidth - 10 - textWidth, pageHeight - 10);

                // Page Number (Center)
                const pageNum = `Page ${i} / ${pageCount}`;
                const pageNumWidth = doc.getTextWidth(pageNum);
                doc.text(pageNum, (pageWidth - pageNumWidth) / 2, pageHeight - 10);
            }

            const fileName = singleId ? "Fiche_Chantier.pdf" : "Rapport_Complet.pdf";
            doc.save(fileName);
        }
        function exportJSON() {
            const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData));
            a.download="backup.json"; document.body.appendChild(a); a.click(); a.remove();
        }

        initApp();
    </script>
</body>
</html>
